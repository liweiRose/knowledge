<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Underscore | Summary of front-end knowledge system</title>
    <meta name="description" content="Knowledge summary">
    
    
    <link rel="preload" href="/knowledge/assets/css/styles.e7eda342.css" as="style"><link rel="preload" href="/knowledge/assets/js/app.e7eda342.js" as="script"><link rel="preload" href="/knowledge/assets/js/79.e238b410.js" as="script"><link rel="prefetch" href="/knowledge/assets/js/1.6c5fe304.js"><link rel="prefetch" href="/knowledge/assets/js/10.e74c9817.js"><link rel="prefetch" href="/knowledge/assets/js/11.7735d178.js"><link rel="prefetch" href="/knowledge/assets/js/12.33e50b7d.js"><link rel="prefetch" href="/knowledge/assets/js/13.e7ec4d82.js"><link rel="prefetch" href="/knowledge/assets/js/14.76fe5404.js"><link rel="prefetch" href="/knowledge/assets/js/15.453f5da6.js"><link rel="prefetch" href="/knowledge/assets/js/16.3b970dca.js"><link rel="prefetch" href="/knowledge/assets/js/17.aa9abea6.js"><link rel="prefetch" href="/knowledge/assets/js/18.3a629017.js"><link rel="prefetch" href="/knowledge/assets/js/19.76269015.js"><link rel="prefetch" href="/knowledge/assets/js/2.af5e1f40.js"><link rel="prefetch" href="/knowledge/assets/js/20.f0beefb9.js"><link rel="prefetch" href="/knowledge/assets/js/21.49d454bd.js"><link rel="prefetch" href="/knowledge/assets/js/22.dbc392f8.js"><link rel="prefetch" href="/knowledge/assets/js/23.3f0ca45f.js"><link rel="prefetch" href="/knowledge/assets/js/24.44f75a62.js"><link rel="prefetch" href="/knowledge/assets/js/25.07fd2c6a.js"><link rel="prefetch" href="/knowledge/assets/js/26.a538fcf4.js"><link rel="prefetch" href="/knowledge/assets/js/27.dd50352e.js"><link rel="prefetch" href="/knowledge/assets/js/28.07194d7d.js"><link rel="prefetch" href="/knowledge/assets/js/29.4a5cb597.js"><link rel="prefetch" href="/knowledge/assets/js/3.7cd1bbf5.js"><link rel="prefetch" href="/knowledge/assets/js/30.b22a2e82.js"><link rel="prefetch" href="/knowledge/assets/js/31.e8923963.js"><link rel="prefetch" href="/knowledge/assets/js/32.4fb9356c.js"><link rel="prefetch" href="/knowledge/assets/js/33.1c9e807a.js"><link rel="prefetch" href="/knowledge/assets/js/34.a4d1a95b.js"><link rel="prefetch" href="/knowledge/assets/js/35.261baf83.js"><link rel="prefetch" href="/knowledge/assets/js/36.b86e0662.js"><link rel="prefetch" href="/knowledge/assets/js/37.a49f45f5.js"><link rel="prefetch" href="/knowledge/assets/js/38.2c928e95.js"><link rel="prefetch" href="/knowledge/assets/js/39.b3440ac7.js"><link rel="prefetch" href="/knowledge/assets/js/4.9046eb02.js"><link rel="prefetch" href="/knowledge/assets/js/40.6d29f8af.js"><link rel="prefetch" href="/knowledge/assets/js/41.1db61fc9.js"><link rel="prefetch" href="/knowledge/assets/js/42.ff223464.js"><link rel="prefetch" href="/knowledge/assets/js/43.38cce5d9.js"><link rel="prefetch" href="/knowledge/assets/js/44.e40d25ff.js"><link rel="prefetch" href="/knowledge/assets/js/45.1af493d1.js"><link rel="prefetch" href="/knowledge/assets/js/46.bd3521ea.js"><link rel="prefetch" href="/knowledge/assets/js/47.53704bce.js"><link rel="prefetch" href="/knowledge/assets/js/48.65ac1a0d.js"><link rel="prefetch" href="/knowledge/assets/js/49.63af183e.js"><link rel="prefetch" href="/knowledge/assets/js/5.484eca69.js"><link rel="prefetch" href="/knowledge/assets/js/50.4a94ed49.js"><link rel="prefetch" href="/knowledge/assets/js/51.3b811165.js"><link rel="prefetch" href="/knowledge/assets/js/52.094ce301.js"><link rel="prefetch" href="/knowledge/assets/js/53.f151cc9b.js"><link rel="prefetch" href="/knowledge/assets/js/54.63d72898.js"><link rel="prefetch" href="/knowledge/assets/js/55.6d675bc7.js"><link rel="prefetch" href="/knowledge/assets/js/56.e3c69b94.js"><link rel="prefetch" href="/knowledge/assets/js/57.df33cce4.js"><link rel="prefetch" href="/knowledge/assets/js/58.f4062866.js"><link rel="prefetch" href="/knowledge/assets/js/59.24391e53.js"><link rel="prefetch" href="/knowledge/assets/js/6.e04b7d46.js"><link rel="prefetch" href="/knowledge/assets/js/60.d54f7240.js"><link rel="prefetch" href="/knowledge/assets/js/61.ef9a9525.js"><link rel="prefetch" href="/knowledge/assets/js/62.3eb51c2b.js"><link rel="prefetch" href="/knowledge/assets/js/63.02f209f2.js"><link rel="prefetch" href="/knowledge/assets/js/64.8195c5a6.js"><link rel="prefetch" href="/knowledge/assets/js/65.10ed2d32.js"><link rel="prefetch" href="/knowledge/assets/js/66.927bb1c0.js"><link rel="prefetch" href="/knowledge/assets/js/67.c4147b68.js"><link rel="prefetch" href="/knowledge/assets/js/68.2da21251.js"><link rel="prefetch" href="/knowledge/assets/js/69.be1a5d72.js"><link rel="prefetch" href="/knowledge/assets/js/7.660053fe.js"><link rel="prefetch" href="/knowledge/assets/js/70.2d838cce.js"><link rel="prefetch" href="/knowledge/assets/js/71.ca5182a8.js"><link rel="prefetch" href="/knowledge/assets/js/72.0fbbd7da.js"><link rel="prefetch" href="/knowledge/assets/js/73.1c92d914.js"><link rel="prefetch" href="/knowledge/assets/js/74.a0b8f90a.js"><link rel="prefetch" href="/knowledge/assets/js/75.2b96f45f.js"><link rel="prefetch" href="/knowledge/assets/js/76.8a7ed686.js"><link rel="prefetch" href="/knowledge/assets/js/77.704cef8b.js"><link rel="prefetch" href="/knowledge/assets/js/78.5ea1748c.js"><link rel="prefetch" href="/knowledge/assets/js/8.2da7363e.js"><link rel="prefetch" href="/knowledge/assets/js/9.c14ae379.js">
    <link rel="stylesheet" href="/knowledge/assets/css/styles.e7eda342.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/knowledge/" class="home-link router-link-active"><!----><span class="site-name">
      Summary of front-end knowledge system
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/liweirose" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/liweirose/knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/liweirose" target="_blank" rel="noopener noreferrer" class="nav-link external">
  更多
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><a href="https://github.com/liweirose/knowledge" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Browser</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>HTML</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>CSS</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JavaScript ES6</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>JS Utils</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Interview</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Engineering</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Engineering Practice</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Underscore SourceCode Parsing</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/knowledge/app/Underscore/Underscore-index.html" class="active sidebar-link">Underscore</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Lodash SourceCode Parsing</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="underscore"><a href="#underscore" aria-hidden="true" class="header-anchor">#</a> Underscore</h1><div class="language-JS extra-class"><pre class="language-js"><code>首先，underscore 的定位是一个功能函数库，提供了 <span class="token number">110</span> 多个 <span class="token constant">API</span> 帮助开发，
所以首先要搞明白的就是那么多的函数，是如何组织的？
是如何做到既可以直接使用，又能以面向对象的方式使用的？
又是如何实现链式调用的？
了解了如何组织代码，甚至从中抽离得到一个模板，
我们再从业务中慢慢总结，最终也能写出自己的 underscore。

接下来是阅读内部函数，其实不多，
只有 cb、optimizeCb、restArgs、shallowProperty、deepGet 而已，
之所以阅读这些函数的实现，是因为在读其他 <span class="token constant">API</span> 时很可能会接触到这些函数，
我第一次在其他 <span class="token constant">API</span> 中看到 cb、optimizeCb、restArgs 函数时都是一脸懵逼，接着看 <span class="token constant">API</span> 吧，
总觉得这点没看懂，心里一直很不爽，转而去看这些函数的实现，
又因为只读了一点源码，想不明白为什么要这样抽象，进退两难，慢慢的就产生了挫败感，
这也就是我为什么会专门写了两篇介绍内部函数，不仅仅是讲解源码，更重要的是希望大家明白为什么要这么抽象。

最后就是跟着兴趣学习，underscore <span class="token constant">API</span> 众多，一个一个看实在是消磨热情，
倒不如你想了解哪个功能就去研究哪个功能的实现，
如果说在这部分有什么建议的话，那就是在研究一些函数具体的实现方式时，
可以参考一些已经写过的源码分析的文章，也许事半功倍：

</code></pre></div><ul><li><p>参考文章</p><ul><li><a href="https://github.com/hanzichi/underscore-analysis/issues/1" target="_blank" rel="noopener noreferrer">hanzichi/underscore-analysis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://yoyoyohamapi.gitbooks.io/undersercore-analysis/content/base/%E7%BB%93%E6%9E%84.html" target="_blank" rel="noopener noreferrer">wuxiaojun/undersercore-analysis<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul><ul><li>以下是源码注解</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//     Underscore.js 1.8.3</span>
<span class="token comment">//     http://underscorejs.org</span>
<span class="token comment">//     (c) 2009-2015 Jeremy Ashkenas, DocumentCloud and Investigative Reporters &amp; Editors</span>
<span class="token comment">//     Underscore may be freely distributed under the MIT license.</span>
<span class="token comment">//     中文注释 by hanzichi @https://github.com/hanzichi</span>
<span class="token comment">//     我的源码解读顺序（跟系列解读文章相对应）</span>
<span class="token comment">//     Object -&gt; Array -&gt; Collection -&gt; Function -&gt; Utility</span>

<span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Baseline setup</span>
  <span class="token comment">// 基本设置、配置</span>
  <span class="token comment">// --------------</span>

  <span class="token comment">// Establish the root object, `window` in the browser, or `exports` on the server.</span>
  <span class="token comment">// 将 this 赋值给局部变量 root</span>
  <span class="token comment">// root 的值, 客户端为 `window`, 服务端(node) 中为 `exports`</span>
  <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

  <span class="token comment">// Save the previous value of the `_` variable.</span>
  <span class="token comment">// 将原来全局环境中的变量 `_` 赋值给变量 previousUnderscore 进行缓存</span>
  <span class="token comment">// 在后面的 noConflict 方法中有用到</span>
  <span class="token keyword">var</span> previousUnderscore <span class="token operator">=</span> root<span class="token punctuation">.</span>_<span class="token punctuation">;</span>

  <span class="token comment">// Save bytes in the minified (but not gzipped) version:</span>
  <span class="token comment">// 缓存变量, 便于压缩代码</span>
  <span class="token comment">// 此处「压缩」指的是压缩到 min.js 版本</span>
  <span class="token comment">// 而不是 gzip 压缩</span>
  <span class="token keyword">var</span> ArrayProto <span class="token operator">=</span> <span class="token class-name">Array</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span>
    ObjProto <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span>
    FuncProto <span class="token operator">=</span> <span class="token class-name">Function</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>

  <span class="token comment">// Create quick reference variables for speed access to core prototypes.</span>
  <span class="token comment">// 缓存变量, 便于压缩代码</span>
  <span class="token comment">// 同时可减少在原型链中的查找次数(提高代码效率)</span>
  <span class="token keyword">var</span> push <span class="token operator">=</span> ArrayProto<span class="token punctuation">.</span>push<span class="token punctuation">,</span>
    slice <span class="token operator">=</span> ArrayProto<span class="token punctuation">.</span>slice<span class="token punctuation">,</span>
    toString <span class="token operator">=</span> ObjProto<span class="token punctuation">.</span>toString<span class="token punctuation">,</span>
    hasOwnProperty <span class="token operator">=</span> ObjProto<span class="token punctuation">.</span>hasOwnProperty<span class="token punctuation">;</span>

  <span class="token comment">// All **ECMAScript 5** native function implementations that we hope to use</span>
  <span class="token comment">// are declared here.</span>
  <span class="token comment">// ES5 原生方法, 如果浏览器支持, 则 underscore 中会优先使用</span>
  <span class="token keyword">var</span> nativeIsArray <span class="token operator">=</span> Array<span class="token punctuation">.</span>isArray<span class="token punctuation">,</span>
    nativeKeys <span class="token operator">=</span> Object<span class="token punctuation">.</span>keys<span class="token punctuation">,</span>
    nativeBind <span class="token operator">=</span> FuncProto<span class="token punctuation">.</span>bind<span class="token punctuation">,</span>
    nativeCreate <span class="token operator">=</span> Object<span class="token punctuation">.</span>create<span class="token punctuation">;</span>

  <span class="token comment">// Naked function reference for surrogate-prototype-swapping.</span>
  <span class="token keyword">var</span> <span class="token function-variable function">Ctor</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a safe reference to the Underscore object for use below.</span>
  <span class="token comment">// 核心函数</span>
  <span class="token comment">// `_` 其实是一个构造函数</span>
  <span class="token comment">// 支持无 new 调用的构造函数（思考 jQuery 的无 new 调用）</span>
  <span class="token comment">// 将传入的参数（实际要操作的数据）赋值给 this._wrapped 属性</span>
  <span class="token comment">// OOP 调用时，_ 相当于一个构造函数</span>
  <span class="token comment">// each 等方法都在该构造函数的原型链上</span>
  <span class="token comment">// _([1, 2, 3]).each(alert)</span>
  <span class="token comment">// _([1, 2, 3]) 相当于无 new 构造了一个新的对象</span>
  <span class="token comment">// 调用了该对象的 each 方法，该方法在该对象构造函数的原型链上</span>
  <span class="token keyword">var</span> <span class="token function-variable function">_</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 以下均针对 OOP 形式的调用</span>
    <span class="token comment">// 如果是非 OOP 形式的调用，不会进入该函数内部</span>

    <span class="token comment">// 如果 obj 已经是 `_` 函数的实例，则直接返回 obj</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>

    <span class="token comment">// 如果不是 `_` 函数的实例</span>
    <span class="token comment">// 则调用 new 运算符，返回实例化的对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 obj 赋值给 this._wrapped 属性</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped <span class="token operator">=</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Export the Underscore object for **Node.js**, with</span>
  <span class="token comment">// backwards-compatibility for the old `require()` API. If we're in</span>
  <span class="token comment">// the browser, add `_` as a global object.</span>
  <span class="token comment">// 将上面定义的 `_` 局部变量赋值给全局对象中的 `_` 属性</span>
  <span class="token comment">// 即客户端中 window._ = _</span>
  <span class="token comment">// 服务端(node)中 exports._ = _</span>
  <span class="token comment">// 同时在服务端向后兼容老的 require() API</span>
  <span class="token comment">// 这样暴露给全局后便可以在全局环境中使用 `_` 变量(方法)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> exports <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> module <span class="token operator">!==</span> <span class="token string">'undefined'</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exports<span class="token punctuation">.</span>_ <span class="token operator">=</span> _<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>_ <span class="token operator">=</span> _<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Current version.</span>
  <span class="token comment">// 当前 underscore 版本号</span>
  _<span class="token punctuation">.</span><span class="token constant">VERSION</span> <span class="token operator">=</span> <span class="token string">'1.8.3'</span><span class="token punctuation">;</span>

  <span class="token comment">// Internal function that returns an efficient (for current engines) version</span>
  <span class="token comment">// of the passed-in callback, to be repeatedly applied in other Underscore</span>
  <span class="token comment">// functions.</span>
  <span class="token comment">// underscore 内部方法</span>
  <span class="token comment">// 根据 this 指向（context 参数）</span>
  <span class="token comment">// 以及 argCount 参数</span>
  <span class="token comment">// 二次操作返回一些回调、迭代方法</span>
  <span class="token keyword">var</span> <span class="token function-variable function">optimizeCb</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> context<span class="token punctuation">,</span> argCount</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果没有指定 this 指向，则返回原函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> func<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>argCount <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">3</span> <span class="token punctuation">:</span> argCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> other</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> value<span class="token punctuation">,</span> other<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果有指定 this，但没有传入 argCount 参数</span>
      <span class="token comment">// 则执行以下 case</span>
      <span class="token comment">// _.each、_.map</span>
      <span class="token keyword">case</span> <span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// _.reduce、_.reduceRight</span>
      <span class="token keyword">case</span> <span class="token number">4</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">accumulator<span class="token punctuation">,</span> value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> accumulator<span class="token punctuation">,</span> value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 其实不用上面的 switch-case 语句</span>
    <span class="token comment">// 直接执行下面的 return 函数就行了</span>
    <span class="token comment">// 不这样做的原因是 call 比 apply 快很多</span>
    <span class="token comment">// .apply 在运行前要对作为参数的数组进行一系列检验和深拷贝，.call 则没有这些步骤</span>
    <span class="token comment">// 具体可以参考：</span>
    <span class="token comment">// https://segmentfault.com/q/1010000007894513</span>
    <span class="token comment">// http://www.ecma-international.org/ecma-262/5.1/#sec-15.3.4.3</span>
    <span class="token comment">// http://www.ecma-international.org/ecma-262/5.1/#sec-15.3.4.4</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// A mostly-internal function to generate callbacks that can be applied</span>
  <span class="token comment">// to each element in a collection, returning the desired result — either</span>
  <span class="token comment">// identity, an arbitrary callback, a property matcher, or a property accessor.</span>
  <span class="token keyword">var</span> <span class="token function-variable function">cb</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> context<span class="token punctuation">,</span> argCount</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> _<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">optimizeCb</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> context<span class="token punctuation">,</span> argCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">iteratee</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">cb</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">Infinity</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// An internal function for creating assigner functions.</span>
  <span class="token comment">// 有三个方法用到了这个内部函数</span>
  <span class="token comment">// _.extend &amp; _.extendOwn &amp; _.defaults</span>
  <span class="token comment">// _.extend = createAssigner(_.allKeys);</span>
  <span class="token comment">// _.extendOwn = _.assign = createAssigner(_.keys);</span>
  <span class="token comment">// _.defaults = createAssigner(_.allKeys, true);</span>
  <span class="token keyword">var</span> <span class="token function-variable function">createAssigner</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">keysFunc<span class="token punctuation">,</span> undefinedOnly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回函数</span>
    <span class="token comment">// 经典闭包（undefinedOnly 参数在返回的函数中被引用）</span>
    <span class="token comment">// 返回的函数参数个数 &gt;= 1</span>
    <span class="token comment">// 将第二个开始的对象参数的键值对 &quot;继承&quot; 给第一个参数</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> length <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token comment">// 只传入了一个参数（或者 0 个？）</span>
      <span class="token comment">// 或者传入的第一个参数是 null</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">||</span> obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>

      <span class="token comment">// 枚举第一个参数除外的对象参数</span>
      <span class="token comment">// 即 arguments[1], arguments[2] ...</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// source 即为对象参数</span>
        <span class="token keyword">var</span> source <span class="token operator">=</span> arguments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token comment">// 提取对象参数的 keys 值</span>
          <span class="token comment">// keysFunc 参数表示 _.keys</span>
          <span class="token comment">// 或者 _.allKeys</span>
          keys <span class="token operator">=</span> <span class="token function">keysFunc</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">,</span>
          l <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token comment">// 遍历该对象的键值对</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token comment">// _.extend 和 _.extendOwn 方法</span>
          <span class="token comment">// 没有传入 undefinedOnly 参数，即 !undefinedOnly 为 true</span>
          <span class="token comment">// 即肯定会执行 obj[key] = source[key]</span>
          <span class="token comment">// 后面对象的键值对直接覆盖 obj</span>
          <span class="token comment">// ==========================================</span>
          <span class="token comment">// _.defaults 方法，undefinedOnly 参数为 true</span>
          <span class="token comment">// 即 !undefinedOnly 为 false</span>
          <span class="token comment">// 那么当且仅当 obj[key] 为 undefined 时才覆盖</span>
          <span class="token comment">// 即如果有相同的 key 值，取最早出现的 value 值</span>
          <span class="token comment">// *defaults 中有相同 key 的也是一样取首次出现的</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>undefinedOnly <span class="token operator">||</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> source<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 返回已经继承后面对象参数属性的第一个参数对象</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// An internal function for creating a new object that inherits from another.</span>
  <span class="token comment">// use in `_.create`</span>
  <span class="token keyword">var</span> <span class="token function-variable function">baseCreate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prototype</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 prototype 参数不是对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果浏览器支持 ES5 Object.create</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeCreate<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">nativeCreate</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Ctor</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> prototype<span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Ctor</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 闭包</span>
  <span class="token keyword">var</span> <span class="token function-variable function">property</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> obj <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token punctuation">:</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Helper for collection methods to determine whether a collection</span>
  <span class="token comment">// should be iterated as an array or as an object</span>
  <span class="token comment">// Related: http://people.mozilla.org/~jorendorff/es6-draft.html#sec-tolength</span>
  <span class="token comment">// Avoids a very nasty iOS 8 JIT bug on ARM-64. #2094</span>

  <span class="token comment">// Math.pow(2, 53) - 1 是 JavaScript 中能精确表示的最大数字</span>
  <span class="token keyword">var</span> <span class="token constant">MAX_ARRAY_INDEX</span> <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// getLength 函数</span>
  <span class="token comment">// 该函数传入一个参数，返回参数的 length 属性值</span>
  <span class="token comment">// 用来获取 array 以及 arrayLike 元素的 length 属性值</span>
  <span class="token keyword">var</span> getLength <span class="token operator">=</span> <span class="token function">property</span><span class="token punctuation">(</span><span class="token string">'length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 判断是否是 ArrayLike Object</span>
  <span class="token comment">// 类数组，即拥有 length 属性并且 length 属性值为 Number 类型的元素</span>
  <span class="token comment">// 包括数组、arguments、HTML Collection 以及 NodeList 等等</span>
  <span class="token comment">// 包括类似 {length: 10} 这样的对象</span>
  <span class="token comment">// 包括字符串、函数等</span>
  <span class="token keyword">var</span> <span class="token function-variable function">isArrayLike</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回参数 collection 的 length 属性值</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token keyword">typeof</span> length <span class="token operator">==</span> <span class="token string">'number'</span> <span class="token operator">&amp;&amp;</span> length <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> length <span class="token operator">&lt;=</span> <span class="token constant">MAX_ARRAY_INDEX</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Collection Functions</span>
  <span class="token comment">// 数组或者对象的扩展方法</span>
  <span class="token comment">// 共 25 个扩展方法</span>
  <span class="token comment">// --------------------</span>

  <span class="token comment">// The cornerstone, an `each` implementation, aka `forEach`.</span>
  <span class="token comment">// Handles raw objects in addition to array-likes. Treats all</span>
  <span class="token comment">// sparse array-likes as if they were dense.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.forEach 使用方法类似</span>
  <span class="token comment">// 遍历数组或者对象的每个元素</span>
  <span class="token comment">// 第一个参数为数组（包括类数组）或者对象</span>
  <span class="token comment">// 第二个参数为迭代方法，对数组或者对象每个元素都执行该方法</span>
  <span class="token comment">// 该方法又能传入三个参数，分别为 (item, index, array)（(value, key, obj) for object）</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.forEach 方法传参格式一致</span>
  <span class="token comment">// 第三个参数（可省略）确定第二个参数 iteratee 函数中的（可能有的）this 指向</span>
  <span class="token comment">// 即 iteratee 中出现的（如果有）所有 this 都指向 context</span>
  <span class="token comment">// notice: 不要传入一个带有 key 类型为 number 的对象！</span>
  <span class="token comment">// notice: _.each 方法不能用 return 跳出循环（同样，Array.prototype.forEach 也不行）</span>
  _<span class="token punctuation">.</span>each <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">forEach</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 context 确定不同的迭代函数</span>
    iteratee <span class="token operator">=</span> <span class="token function">optimizeCb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> i<span class="token punctuation">,</span> length<span class="token punctuation">;</span>

    <span class="token comment">// 如果是类数组</span>
    <span class="token comment">// 默认不会传入类似 {length: 10} 这样的数据</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 遍历</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> obj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">iteratee</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 obj 是对象</span>
      <span class="token comment">// 获取对象的所有 key 值</span>
      <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果是对象，则遍历处理 values 值</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">iteratee</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (value, key, obj)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回 obj 参数</span>
    <span class="token comment">// 供链式调用（Returns the list for chaining）</span>
    <span class="token comment">// 应该仅 OOP 调用有效</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the results of applying the iteratee to each element.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.map 使用方法类似</span>
  <span class="token comment">// 传参形式与 _.each 方法类似</span>
  <span class="token comment">// 遍历数组（每个元素）或者对象的每个元素（value）</span>
  <span class="token comment">// 对每个元素执行 iteratee 迭代方法</span>
  <span class="token comment">// 将结果保存到新的数组中，并返回</span>
  _<span class="token punctuation">.</span>map <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">collect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 context 确定不同的迭代函数</span>
    iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传参是对象，则获取它的 keys 值数组（短路表达式）</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token comment">// 如果 obj 为对象，则 length 为 key.length</span>
      <span class="token comment">// 如果 obj 为数组，则 length 为 obj.length</span>
      length <span class="token operator">=</span> <span class="token punctuation">(</span>keys <span class="token operator">||</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      results <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 结果数组</span>

    <span class="token comment">// 遍历</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 obj 为对象，则 currentKey 为对象键值 key</span>
      <span class="token comment">// 如果 obj 为数组，则 currentKey 为 index 值</span>
      <span class="token keyword">var</span> currentKey <span class="token operator">=</span> keys <span class="token operator">?</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> index<span class="token punctuation">;</span>
      results<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span><span class="token punctuation">,</span> currentKey<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回新的结果数组</span>
    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a reducing function iterating left or right.</span>
  <span class="token comment">// dir === 1 -&gt; _.reduce</span>
  <span class="token comment">// dir === -1 -&gt; _.reduceRight</span>
  <span class="token keyword">function</span> <span class="token function">createReduce</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Optimized iterator function as using arguments.length</span>
    <span class="token comment">// in the main function will deoptimize the, see #1991.</span>
    <span class="token keyword">function</span> <span class="token function">iterator</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> memo<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> index<span class="token punctuation">,</span> length</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> index <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index <span class="token operator">+=</span> dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> currentKey <span class="token operator">=</span> keys <span class="token operator">?</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> index<span class="token punctuation">;</span>
        <span class="token comment">// 迭代，返回值供下次迭代调用</span>
        memo <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>memo<span class="token punctuation">,</span> obj<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span><span class="token punctuation">,</span> currentKey<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// 每次迭代返回值，供下次迭代调用</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// _.reduce（_.reduceRight）可传入的 4 个参数</span>
    <span class="token comment">// obj 数组或者对象</span>
    <span class="token comment">// iteratee 迭代方法，对数组或者对象每个元素执行该方法</span>
    <span class="token comment">// memo 初始值，如果有，则从 obj 第一个元素开始迭代</span>
    <span class="token comment">// 如果没有，则从 obj 第二个元素开始迭代，将第一个元素作为初始值</span>
    <span class="token comment">// context 为迭代函数中的 this 指向</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> memo<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      iteratee <span class="token operator">=</span> <span class="token function">optimizeCb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> <span class="token punctuation">(</span>keys <span class="token operator">||</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">,</span>
        index <span class="token operator">=</span> dir <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token comment">// Determine the initial value if none is provided.</span>
      <span class="token comment">// 如果没有指定初始值</span>
      <span class="token comment">// 则把第一个元素指定为初始值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        memo <span class="token operator">=</span> obj<span class="token punctuation">[</span>keys <span class="token operator">?</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> index<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据 dir 确定是向左还是向右遍历</span>
        index <span class="token operator">+=</span> dir<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token function">iterator</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> memo<span class="token punctuation">,</span> keys<span class="token punctuation">,</span> index<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// **Reduce** builds up a single result from a list of values, aka `inject`,</span>
  <span class="token comment">// or `foldl`.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.reduce 使用方法类似</span>
  <span class="token comment">// _.reduce(list, iteratee, [memo], [context])</span>
  <span class="token comment">// _.reduce 方法最多可传入 4 个参数</span>
  <span class="token comment">// memo 为初始值，可选</span>
  <span class="token comment">// context 为指定 iteratee 中 this 指向，可选</span>
  _<span class="token punctuation">.</span>reduce <span class="token operator">=</span> _<span class="token punctuation">.</span>foldl <span class="token operator">=</span> _<span class="token punctuation">.</span>inject <span class="token operator">=</span> <span class="token function">createReduce</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The right-associative version of reduce, also known as `foldr`.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.reduceRight 使用方法类似</span>
  _<span class="token punctuation">.</span>reduceRight <span class="token operator">=</span> _<span class="token punctuation">.</span>foldr <span class="token operator">=</span> <span class="token function">createReduce</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the first value which passes a truth test. Aliased as `detect`.</span>
  <span class="token comment">// 寻找数组或者对象中第一个满足条件（predicate 函数返回 true）的元素</span>
  <span class="token comment">// 并返回该元素值</span>
  <span class="token comment">// _.find(list, predicate, [context])</span>
  _<span class="token punctuation">.</span>find <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">detect</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> key<span class="token punctuation">;</span>
    <span class="token comment">// 如果 obj 是数组，key 为满足条件的下标</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      key <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 obj 是对象，key 为满足条件的元素的 key 值</span>
      key <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">findKey</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果该元素存在，则返回该元素</span>
    <span class="token comment">// 如果不存在，则默认返回 undefined（函数没有返回，即返回 undefined）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!==</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> key <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return all the elements that pass a truth test.</span>
  <span class="token comment">// Aliased as `select`.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.filter 使用方法类似</span>
  <span class="token comment">// 寻找数组或者对象中所有满足条件的元素</span>
  <span class="token comment">// 如果是数组，则将 `元素值` 存入数组</span>
  <span class="token comment">// 如果是对象，则将 `value 值` 存入数组</span>
  <span class="token comment">// 返回该数组</span>
  <span class="token comment">// _.filter(list, predicate, [context])</span>
  _<span class="token punctuation">.</span>filter <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">select</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> results <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 this 指向，返回 predicate 函数（判断函数）</span>
    predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历每个元素，如果符合条件则存入数组</span>
    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">)</span> results<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return all the elements for which a truth test fails.</span>
  <span class="token comment">// 寻找数组或者对象中所有不满足条件的元素</span>
  <span class="token comment">// 并以数组方式返回</span>
  <span class="token comment">// 所得结果是 _.filter 方法的补集</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine whether all of the elements match a truth test.</span>
  <span class="token comment">// Aliased as `all`.</span>
  <span class="token comment">// 与 ES5 中的 Array.prototype.every 方法类似</span>
  <span class="token comment">// 判断数组中的每个元素或者对象中每个 value 值是否都满足 predicate 函数中的判断条件</span>
  <span class="token comment">// 如果是，则返回 ture；否则返回 false（有一个不满足就返回 false）</span>
  <span class="token comment">// _.every(list, [predicate], [context])</span>
  _<span class="token punctuation">.</span>every <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 this 指向，返回相应 predicate 函数</span>
    predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      length <span class="token operator">=</span> <span class="token punctuation">(</span>keys <span class="token operator">||</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> currentKey <span class="token operator">=</span> keys <span class="token operator">?</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> index<span class="token punctuation">;</span>
      <span class="token comment">// 如果有一个不能满足 predicate 中的条件</span>
      <span class="token comment">// 则返回 false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">predicate</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span><span class="token punctuation">,</span> currentKey<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine if at least one element in the object matches a truth test.</span>
  <span class="token comment">// Aliased as `any`.</span>
  <span class="token comment">// 与 ES5 中 Array.prototype.some 方法类似</span>
  <span class="token comment">// 判断数组或者对象中是否有一个元素（value 值 for object）满足 predicate 函数中的条件</span>
  <span class="token comment">// 如果是则返回 true；否则返回 false</span>
  <span class="token comment">// _.some(list, [predicate], [context])</span>
  _<span class="token punctuation">.</span>some <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">any</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 context 返回 predicate 函数</span>
    predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果传参是对象，则返回该对象的 keys 数组</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      length <span class="token operator">=</span> <span class="token punctuation">(</span>keys <span class="token operator">||</span> obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> currentKey <span class="token operator">=</span> keys <span class="token operator">?</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token punctuation">:</span> index<span class="token punctuation">;</span>
      <span class="token comment">// 如果有一个元素满足条件，则返回 true</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span><span class="token punctuation">,</span> currentKey<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Determine if the array or object contains a given item (using `===`).</span>
  <span class="token comment">// Aliased as `includes` and `include`.</span>
  <span class="token comment">// 判断数组或者对象中（value 值）是否有指定元素</span>
  <span class="token comment">// 如果是 object，则忽略 key 值，只需要查找 value 值即可</span>
  <span class="token comment">// 即该 obj 中是否有指定的 value 值</span>
  <span class="token comment">// 返回布尔值</span>
  _<span class="token punctuation">.</span>contains <span class="token operator">=</span> _<span class="token punctuation">.</span>includes <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">include</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> item<span class="token punctuation">,</span> fromIndex<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是对象，返回 values 组成的数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> obj <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// fromIndex 表示查询起始位置</span>
    <span class="token comment">// 如果没有指定该参数，则默认从头找起</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fromIndex <span class="token operator">!=</span> <span class="token string">'number'</span> <span class="token operator">||</span> guard<span class="token punctuation">)</span> fromIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// _.indexOf 是数组的扩展方法（Array Functions）</span>
    <span class="token comment">// 数组中寻找某一元素</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> item<span class="token punctuation">,</span> fromIndex<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Invoke a method (with arguments) on every item in a collection.</span>
  <span class="token comment">// Calls the method named by methodName on each value in the list.</span>
  <span class="token comment">// Any extra arguments passed to invoke will be forwarded on to the method invocation.</span>
  <span class="token comment">// 数组或者对象中的每个元素都调用 method 方法</span>
  <span class="token comment">// 返回调用后的结果（数组或者关联数组）</span>
  <span class="token comment">// method 参数后的参数会被当做参数传入 method 方法中</span>
  <span class="token comment">// _.invoke(list, methodName, *arguments)</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">invoke</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// *arguments 参数</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 判断 method 是不是函数</span>
    <span class="token keyword">var</span> isFunc <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用 map 方法对数组或者对象每个元素调用方法</span>
    <span class="token comment">// 返回数组</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 method 不是函数，则可能是 obj 的 key 值</span>
      <span class="token comment">// 而 obj[method] 可能为函数</span>
      <span class="token keyword">var</span> func <span class="token operator">=</span> isFunc <span class="token operator">?</span> method <span class="token punctuation">:</span> value<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> func <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> func <span class="token punctuation">:</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Convenience version of a common use case of `map`: fetching a property.</span>
  <span class="token comment">// 一个数组，元素都是对象</span>
  <span class="token comment">// 根据指定的 key 值</span>
  <span class="token comment">// 返回一个数组，元素都是指定 key 值的 value 值</span>
  <span class="token comment">/*
  var property = function(key) {
    return function(obj) {
      return obj == null ? void 0 : obj[key];
    };
  };
  */</span>
  <span class="token comment">// _.pluck(list, propertyName)</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">pluck</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">property</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Convenience version of a common use case of `filter`: selecting only objects</span>
  <span class="token comment">// containing specific `key:value` pairs.</span>
  <span class="token comment">// 根据指定的键值对</span>
  <span class="token comment">// 选择对象</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">where</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Convenience version of a common use case of `find`: getting the first object</span>
  <span class="token comment">// containing specific `key:value` pairs.</span>
  <span class="token comment">// 寻找第一个有指定 key-value 键值对的对象</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">findWhere</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> _<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the maximum element (or element-based computation).</span>
  <span class="token comment">// 寻找数组中的最大元素</span>
  <span class="token comment">// 或者对象中的最大 value 值</span>
  <span class="token comment">// 如果有 iteratee 参数，则求每个元素经过该函数迭代后的最值</span>
  <span class="token comment">// _.max(list, [iteratee], [context])</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">max</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">,</span>
      lastComputed <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">,</span>
      value<span class="token punctuation">,</span>
      computed<span class="token punctuation">;</span>

    <span class="token comment">// 单纯地寻找最值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratee <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是数组，则寻找数组中最大元素</span>
      <span class="token comment">// 如果是对象，则寻找最大 value 值</span>
      obj <span class="token operator">=</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> obj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&gt;</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 寻找元素经过迭代后的最值</span>
      iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// result 保存结果元素</span>
      <span class="token comment">// lastComputed 保存计算过程中出现的最值</span>
      <span class="token comment">// 遍历元素</span>
      _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 经过迭代函数后的值</span>
        computed <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// &amp;&amp; 的优先级高于 ||</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          computed <span class="token operator">&gt;</span> lastComputed <span class="token operator">||</span>
          <span class="token punctuation">(</span>computed <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">Infinity</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">Infinity</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> value<span class="token punctuation">;</span>
          lastComputed <span class="token operator">=</span> computed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the minimum element (or element-based computation).</span>
  <span class="token comment">// 寻找最小的元素</span>
  <span class="token comment">// 类似 _.max</span>
  <span class="token comment">// _.min(list, [iteratee], [context])</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">min</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
      lastComputed <span class="token operator">=</span> <span class="token number">Infinity</span><span class="token punctuation">,</span>
      value<span class="token punctuation">,</span>
      computed<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratee <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      obj <span class="token operator">=</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> obj<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        computed <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          computed <span class="token operator">&lt;</span> lastComputed <span class="token operator">||</span>
          <span class="token punctuation">(</span>computed <span class="token operator">===</span> <span class="token number">Infinity</span> <span class="token operator">&amp;&amp;</span> result <span class="token operator">===</span> <span class="token number">Infinity</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          result <span class="token operator">=</span> value<span class="token punctuation">;</span>
          lastComputed <span class="token operator">=</span> computed<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Shuffle a collection, using the modern version of the</span>
  <span class="token comment">// [Fisher-Yates shuffle](http://en.wikipedia.org/wiki/Fisher–Yates_shuffle).</span>
  <span class="token comment">// 将数组乱序</span>
  <span class="token comment">// 如果是对象，则返回一个数组，数组由对象 value 值构成</span>
  <span class="token comment">// Fisher-Yates shuffle 算法</span>
  <span class="token comment">// 最优的洗牌算法，复杂度 O(n)</span>
  <span class="token comment">// 乱序不要用 sort + Math.random()，复杂度 O(nlogn)</span>
  <span class="token comment">// 而且，并不是真正的乱序</span>
  <span class="token comment">// @see https://github.com/hanzichi/underscore-analysis/issues/15</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">shuffle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是对象，则对 value 值进行乱序</span>
    <span class="token keyword">var</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token keyword">set</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// 乱序后返回的数组副本（参数是对象则返回乱序后的 value 数组）</span>
    <span class="token keyword">var</span> shuffled <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 枚举元素</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> rand<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将当前所枚举位置的元素和 `index=rand` 位置的元素交换</span>
      rand <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>rand <span class="token operator">!==</span> index<span class="token punctuation">)</span> shuffled<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> shuffled<span class="token punctuation">[</span>rand<span class="token punctuation">]</span><span class="token punctuation">;</span>
      shuffled<span class="token punctuation">[</span>rand<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">set</span><span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> shuffled<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Sample **n** random values from a collection.</span>
  <span class="token comment">// If **n** is not specified, returns a single random element.</span>
  <span class="token comment">// The internal `guard` argument allows it to work with `map`.</span>
  <span class="token comment">// 随机返回数组或者对象中的一个元素</span>
  <span class="token comment">// 如果指定了参数 `n`，则随机返回 n 个元素组成的数组</span>
  <span class="token comment">// 如果参数是对象，则数组由 values 组成</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">sample</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> n<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 随机返回一个元素</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> guard<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> obj <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">[</span>_<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 随机返回 n 个</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Sort the object's values by a criterion produced by an iteratee.</span>
  <span class="token comment">// 排序</span>
  <span class="token comment">// _.sortBy(list, iteratee, [context])</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">sortBy</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据指定的 key 返回 values 数组</span>
    <span class="token comment">// _.pluck([{}, {}, {}], 'value')</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span>
      <span class="token comment">// _.map(obj, function(){}).sort()</span>
      <span class="token comment">// _.map 后的结果 [{}, {}..]</span>
      <span class="token comment">// sort 后的结果 [{}, {}..]</span>
      _<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          value<span class="token punctuation">:</span> value<span class="token punctuation">,</span>
          index<span class="token punctuation">:</span> index<span class="token punctuation">,</span>
          <span class="token comment">// 元素经过迭代函数迭代后的值</span>
          criteria<span class="token punctuation">:</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> list<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">left<span class="token punctuation">,</span> right</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> a <span class="token operator">=</span> left<span class="token punctuation">.</span>criteria<span class="token punctuation">;</span>
        <span class="token keyword">var</span> b <span class="token operator">=</span> right<span class="token punctuation">.</span>criteria<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">!==</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&gt;</span> b <span class="token operator">||</span> a <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;</span> b <span class="token operator">||</span> b <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> left<span class="token punctuation">.</span>index <span class="token operator">-</span> right<span class="token punctuation">.</span>index<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'value'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// An internal function used for aggregate &quot;group by&quot; operations.</span>
  <span class="token comment">// behavior 是一个函数参数</span>
  <span class="token comment">// _.groupBy, _.indexBy 以及 _.countBy 其实都是对数组元素进行分类</span>
  <span class="token comment">// 分类规则就是 behavior 函数</span>
  <span class="token keyword">var</span> <span class="token function-variable function">group</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">behavior</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 返回结果是一个对象</span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 遍历元素</span>
      _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 经过迭代，获取结果值，存为 key</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> index<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 按照不同的规则进行分组操作</span>
        <span class="token comment">// 将变量 result 当做参数传入，能在 behavior 中改变该值</span>
        <span class="token function">behavior</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 返回结果对象</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Groups the object's values by a criterion. Pass either a string attribute</span>
  <span class="token comment">// to group by, or a function that returns the criterion.</span>
  <span class="token comment">// groupBy_  _.groupBy(list, iteratee, [context])</span>
  <span class="token comment">// 根据特定规则对数组或者对象中的元素进行分组</span>
  <span class="token comment">// result 是返回对象</span>
  <span class="token comment">// value 是数组元素</span>
  <span class="token comment">// key 是迭代后的值</span>
  _<span class="token punctuation">.</span>groupBy <span class="token operator">=</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 根据 key 值分组</span>
    <span class="token comment">// key 是元素经过迭代函数后的值</span>
    <span class="token comment">// 或者元素自身的属性值</span>

    <span class="token comment">// result 对象已经有该 key 值了</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Indexes the object's values by a criterion, similar to `groupBy`, but for</span>
  <span class="token comment">// when you know that your index values will be unique.</span>
  _<span class="token punctuation">.</span>indexBy <span class="token operator">=</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// key 值必须是独一无二的</span>
    <span class="token comment">// 不然后面的会覆盖前面的</span>
    <span class="token comment">// 其他和 _.groupBy 类似</span>
    result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Counts instances of an object that group by a certain criterion. Pass</span>
  <span class="token comment">// either a string attribute to count by, or a function that returns the</span>
  <span class="token comment">// criterion.</span>
  _<span class="token punctuation">.</span>countBy <span class="token operator">=</span> <span class="token function">group</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">result<span class="token punctuation">,</span> value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 不同 key 值元素数量</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Safely create a real, live array from anything iterable.</span>
  <span class="token comment">// 伪数组 -&gt; 数组</span>
  <span class="token comment">// 对象 -&gt; 提取 value 值组成数组</span>
  <span class="token comment">// 返回数组</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">toArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是数组，则返回副本数组</span>
    <span class="token comment">// 是否用 obj.concat() 更方便？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是类数组，则重新构造新的数组</span>
    <span class="token comment">// 是否也可以直接用 slice 方法？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> _<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是对象，则返回 values 集合</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return the number of elements in an object.</span>
  <span class="token comment">// 如果是数组（类数组），返回长度（length 属性）</span>
  <span class="token comment">// 如果是对象，返回键值对数量</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">size</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj<span class="token punctuation">.</span>length <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Split a collection into two arrays: one whose elements all satisfy the given</span>
  <span class="token comment">// predicate, and one whose elements all do not satisfy the predicate.</span>
  <span class="token comment">// 将数组或者对象中符合条件（predicate）的元素</span>
  <span class="token comment">// 和不符合条件的元素（数组为元素，对象为 value 值）</span>
  <span class="token comment">// 分别放入两个数组中</span>
  <span class="token comment">// 返回一个数组，数组元素为以上两个数组（[[pass array], [fail array]]）</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">partition</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> pass <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      fail <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span> <span class="token operator">?</span> pass <span class="token punctuation">:</span> fail<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>pass<span class="token punctuation">,</span> fail<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Array Functions</span>
  <span class="token comment">// 数组的扩展方法</span>
  <span class="token comment">// 共 20 个扩展方法</span>
  <span class="token comment">// Note: All array functions will also work on the arguments object.</span>
  <span class="token comment">// However, Underscore functions are not designed to work on &quot;sparse&quot; arrays.</span>
  <span class="token comment">// ---------------</span>

  <span class="token comment">// Get the first element of an array. Passing **n** will return the first N</span>
  <span class="token comment">// values in the array. Aliased as `head` and `take`. The **guard** check</span>
  <span class="token comment">// allows it to work with `_.map`.</span>
  <span class="token comment">// 返回数组第一个元素</span>
  <span class="token comment">// 如果有参数 n，则返回数组前 n 个元素（组成的数组）</span>
  _<span class="token punctuation">.</span>first <span class="token operator">=</span> _<span class="token punctuation">.</span>head <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">take</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 容错，数组为空则返回 undefined</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>array <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 没指定参数 n，则默认返回第一个元素</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> guard<span class="token punctuation">)</span> <span class="token keyword">return</span> array<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传入参数 n，则返回前 n 个元素组成的数组</span>
    <span class="token comment">// 返回前 n 个元素，即剔除后 array.length - n 个元素</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">initial</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> array<span class="token punctuation">.</span>length <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns everything but the last entry of the array. Especially useful on</span>
  <span class="token comment">// the arguments object. Passing **n** will return all the values in</span>
  <span class="token comment">// the array, excluding the last N.</span>
  <span class="token comment">// 传入一个数组</span>
  <span class="token comment">// 返回剔除最后一个元素之后的数组副本</span>
  <span class="token comment">// 如果传入参数 n，则剔除最后 n 个元素</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">initial</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>
      array<span class="token punctuation">,</span>
      <span class="token number">0</span><span class="token punctuation">,</span>
      Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> guard <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Get the last element of an array. Passing **n** will return the last N</span>
  <span class="token comment">// values in the array.</span>
  <span class="token comment">// 返回数组最后一个元素</span>
  <span class="token comment">// 如果传入参数 n</span>
  <span class="token comment">// 则返回该数组后 n 个元素组成的数组</span>
  <span class="token comment">// 即剔除前 array.length - n 个元素</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">last</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 容错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>array <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果没有指定参数 n，则返回最后一个元素</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> guard<span class="token punctuation">)</span> <span class="token keyword">return</span> array<span class="token punctuation">[</span>array<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传入参数 n，则返回后 n 个元素组成的数组</span>
    <span class="token comment">// 即剔除前 array.length - n 个元素</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> array<span class="token punctuation">.</span>length <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns everything but the first entry of the array. Aliased as `tail` and `drop`.</span>
  <span class="token comment">// Especially useful on the arguments object. Passing an **n** will return</span>
  <span class="token comment">// the rest N values in the array.</span>
  <span class="token comment">// 传入一个数组</span>
  <span class="token comment">// 返回剔除第一个元素后的数组副本</span>
  <span class="token comment">// 如果传入参数 n，则剔除前 n 个元素</span>
  _<span class="token punctuation">.</span>rest <span class="token operator">=</span> _<span class="token punctuation">.</span>tail <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">drop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> n<span class="token punctuation">,</span> guard</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> n <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> guard <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Trim out all falsy values from an array.</span>
  <span class="token comment">// 去掉数组中所有的假值</span>
  <span class="token comment">// 返回数组副本</span>
  <span class="token comment">// JavaScript 中的假值包括 false、null、undefined、''、NaN、0</span>
  <span class="token comment">// 联想 PHP 中的 array_filter() 函数</span>
  <span class="token comment">// _.identity = function(value) {</span>
  <span class="token comment">//   return value;</span>
  <span class="token comment">// };</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">compact</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> _<span class="token punctuation">.</span>identity<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Internal implementation of a recursive `flatten` function.</span>
  <span class="token comment">// 递归调用数组，将数组展开</span>
  <span class="token comment">// 即 [1, 2, [3, 4]] =&gt; [1, 2, 3, 4]</span>
  <span class="token comment">// flatten(array, shallow, false)</span>
  <span class="token comment">// flatten(arguments, true, true, 1)</span>
  <span class="token comment">// flatten(arguments, true, true)</span>
  <span class="token comment">// flatten(arguments, false, false, 1)</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// input =&gt; Array 或者 arguments</span>
  <span class="token comment">// shallow =&gt; 是否只展开一层</span>
  <span class="token comment">// strict === true，通常和 shallow === true 配合使用</span>
  <span class="token comment">// 表示只展开一层，但是不保存非数组元素（即无法展开的基础类型）</span>
  <span class="token comment">// flatten([[1, 2], 3, 4], true, true) =&gt; [1, 2]</span>
  <span class="token comment">// flatten([[1, 2], 3, 4], false, true) = &gt; []</span>
  <span class="token comment">// startIndex =&gt; 从 input 的第几项开始展开</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 可以看到，如果 strict 参数为 true，那么 shallow 也为 true</span>
  <span class="token comment">// 也就是展开一层，同时把非数组过滤</span>
  <span class="token comment">// [[1, 2], [3, 4], 5, 6] =&gt; [1, 2, 3, 4]</span>
  <span class="token keyword">var</span> <span class="token function-variable function">flatten</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">input<span class="token punctuation">,</span> shallow<span class="token punctuation">,</span> strict<span class="token punctuation">,</span> startIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// output 数组保存结果</span>
    <span class="token comment">// 即 flatten 方法返回数据</span>
    <span class="token comment">// idx 为 output 的累计数组下标</span>
    <span class="token keyword">var</span> output <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据 startIndex 变量确定需要展开的起始位置</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> startIndex <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> input<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 数组 或者 arguments</span>
      <span class="token comment">// 注意 isArrayLike 还包括 {length: 10} 这样的，过滤掉</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isArrayLike</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">||</span> _<span class="token punctuation">.</span><span class="token function">isArguments</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// flatten current level of array or arguments object</span>
        <span class="token comment">// (!shallow === true) =&gt; (shallow === false)</span>
        <span class="token comment">// 则表示需深度展开</span>
        <span class="token comment">// 继续递归展开</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shallow<span class="token punctuation">)</span>
          <span class="token comment">// flatten 方法返回数组</span>
          <span class="token comment">// 将上面定义的 value 重新赋值</span>
          value <span class="token operator">=</span> <span class="token function">flatten</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> shallow<span class="token punctuation">,</span> strict<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 递归展开到最后一层（没有嵌套的数组了）</span>
        <span class="token comment">// 或者 (shallow === true) =&gt; 只展开一层</span>
        <span class="token comment">// value 值肯定是一个数组</span>
        <span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
          len <span class="token operator">=</span> value<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

        <span class="token comment">// 这一步貌似没有必要</span>
        <span class="token comment">// 毕竟 JavaScript 的数组会自动扩充</span>
        <span class="token comment">// 但是这样写，感觉比较好，对于元素的 push 过程有个比较清晰的认识</span>
        output<span class="token punctuation">.</span>length <span class="token operator">+=</span> len<span class="token punctuation">;</span>

        <span class="token comment">// 将 value 数组的元素添加到 output 数组中</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          output<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strict<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// (!strict === true) =&gt; (strict === false)</span>
        <span class="token comment">// 如果是深度展开，即 shallow 参数为 false</span>
        <span class="token comment">// 那么当最后 value 不是数组，是基本类型时</span>
        <span class="token comment">// 肯定会走到这个 else-if 判断中</span>
        <span class="token comment">// 而如果此时 strict 为 true，则不能跳到这个分支内部</span>
        <span class="token comment">// 所以 shallow === false 如果和 strict === true 搭配</span>
        <span class="token comment">// 调用 flatten 方法得到的结果永远是空数组 []</span>
        output<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> output<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Flatten out an array, either recursively (by default), or just one level.</span>
  <span class="token comment">// 将嵌套的数组展开</span>
  <span class="token comment">// 如果参数 (shallow === true)，则仅展开一层</span>
  <span class="token comment">// _.flatten([1, [2], [3, [[4]]]]);</span>
  <span class="token comment">// =&gt; [1, 2, 3, 4];</span>
  <span class="token comment">// ====== //</span>
  <span class="token comment">// _.flatten([1, [2], [3, [[4]]]], true);</span>
  <span class="token comment">// =&gt; [1, 2, 3, [[4]]];</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">flatten</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> shallow</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// array =&gt; 需要展开的数组</span>
    <span class="token comment">// shallow =&gt; 是否只展开一层</span>
    <span class="token comment">// false 为 flatten 方法 strict 变量</span>
    <span class="token keyword">return</span> <span class="token function">flatten</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> shallow<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a version of the array that does not contain the specified value(s).</span>
  <span class="token comment">// without_.without(array, *values)</span>
  <span class="token comment">// Returns a copy of the array with all instances of the values removed.</span>
  <span class="token comment">// ====== //</span>
  <span class="token comment">// _.without([1, 2, 1, 0, 3, 1, 4], 0, 1);</span>
  <span class="token comment">// =&gt; [2, 3, 4]</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 从数组中移除指定的元素</span>
  <span class="token comment">// 返回移除后的数组副本</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">without</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// slice.call(arguments, 1)</span>
    <span class="token comment">// 将 arguments 转为数组（同时去掉第一个元素）</span>
    <span class="token comment">// 之后便可以调用 _.difference 方法</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">difference</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Produce a duplicate-free version of the array. If the array has already</span>
  <span class="token comment">// been sorted, you have the option of using a faster algorithm.</span>
  <span class="token comment">// Aliased as `unique`.</span>
  <span class="token comment">// 数组去重</span>
  <span class="token comment">// 如果第二个参数 `isSorted` 为 true</span>
  <span class="token comment">// 则说明事先已经知道数组有序</span>
  <span class="token comment">// 程序会跑一个更快的算法（一次线性比较，元素和数组前一个元素比较即可）</span>
  <span class="token comment">// 如果有第三个参数 iteratee，则对数组每个元素迭代</span>
  <span class="token comment">// 对迭代之后的结果进行去重</span>
  <span class="token comment">// 返回去重后的数组（array 的子数组）</span>
  <span class="token comment">// PS: 暴露的 API 中没 context 参数</span>
  <span class="token comment">// _.uniq(array, [isSorted], [iteratee])</span>
  _<span class="token punctuation">.</span>uniq <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">unique</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> isSorted<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有传入 isSorted 参数</span>
    <span class="token comment">// 转为 _.unique(array, false, undefined, iteratee)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isBoolean</span><span class="token punctuation">(</span>isSorted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context <span class="token operator">=</span> iteratee<span class="token punctuation">;</span>
      iteratee <span class="token operator">=</span> isSorted<span class="token punctuation">;</span>
      isSorted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果有迭代函数</span>
    <span class="token comment">// 则根据 this 指向二次返回新的迭代函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratee <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 结果数组，是 array 的子集</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 已经出现过的元素（或者经过迭代过的值）</span>
    <span class="token comment">// 用来过滤重复值</span>
    <span class="token keyword">var</span> seen <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token comment">// 如果指定了迭代函数</span>
        <span class="token comment">// 则对数组每一个元素进行迭代</span>
        <span class="token comment">// 迭代函数传入的三个参数通常是 value, index, array 形式</span>
        computed <span class="token operator">=</span> iteratee <span class="token operator">?</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> i<span class="token punctuation">,</span> array<span class="token punctuation">)</span> <span class="token punctuation">:</span> value<span class="token punctuation">;</span>

      <span class="token comment">// 如果是有序数组，则当前元素只需跟上一个元素对比即可</span>
      <span class="token comment">// 用 seen 变量保存上一个元素</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isSorted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 i === 0，是第一个元素，则直接 push</span>
        <span class="token comment">// 否则比较当前元素是否和前一个元素相等</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>i <span class="token operator">||</span> seen <span class="token operator">!==</span> computed<span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// seen 保存当前元素，供下一次对比</span>
        seen <span class="token operator">=</span> computed<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iteratee<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果 seen[] 中没有 computed 这个元素值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>seen<span class="token punctuation">,</span> computed<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          seen<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>computed<span class="token punctuation">)</span><span class="token punctuation">;</span>
          result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果不用经过迭代函数计算，也就不用 seen[] 变量了</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Produce an array that contains the union: each distinct element from all of</span>
  <span class="token comment">// the passed-in arrays.</span>
  <span class="token comment">// union_.union(*arrays)</span>
  <span class="token comment">// Computes the union of the passed-in arrays:</span>
  <span class="token comment">// the list of unique items, in order, that are present in one or more of the arrays.</span>
  <span class="token comment">// ========== //</span>
  <span class="token comment">// _.union([1, 2, 3], [101, 2, 1, 10], [2, 1]);</span>
  <span class="token comment">// =&gt; [1, 2, 3, 101, 10]</span>
  <span class="token comment">// ========== //</span>
  <span class="token comment">// 将多个数组的元素集中到一个数组中</span>
  <span class="token comment">// 并且去重，返回数组副本</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">union</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 首先用 flatten 方法将传入的数组展开成一个数组</span>
    <span class="token comment">// 然后就可以愉快地调用 _.uniq 方法了</span>
    <span class="token comment">// 假设 _.union([1, 2, 3], [101, 2, 1, 10], [2, 1]);</span>
    <span class="token comment">// arguments 为 [[1, 2, 3], [101, 2, 1, 10], [2, 1]]</span>
    <span class="token comment">// shallow 参数为 true，展开一层</span>
    <span class="token comment">// 结果为 [1, 2, 3, 101, 2, 1, 10, 2, 1]</span>
    <span class="token comment">// 然后对其去重</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">uniq</span><span class="token punctuation">(</span><span class="token function">flatten</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Produce an array that contains every item shared between all the</span>
  <span class="token comment">// passed-in arrays.</span>
  <span class="token comment">// 寻找几个数组中共有的元素</span>
  <span class="token comment">// 将这些每个数组中都有的元素存入另一个数组中返回</span>
  <span class="token comment">// _.intersection(*arrays)</span>
  <span class="token comment">// _.intersection([1, 2, 3, 1], [101, 2, 1, 10, 1], [2, 1, 1])</span>
  <span class="token comment">// =&gt; [1, 2]</span>
  <span class="token comment">// 注意：返回的结果数组是去重的</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">intersection</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 结果数组</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 传入的参数（数组）个数</span>
    <span class="token keyword">var</span> argsLength <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// 遍历第一个数组的元素</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> item <span class="token operator">=</span> array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果 result[] 中已经有 item 元素了，continue</span>
      <span class="token comment">// 即 array 中出现了相同的元素</span>
      <span class="token comment">// 返回的 result[] 其实是个 &quot;集合&quot;（是去重的）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

      <span class="token comment">// 判断其他参数数组中是否都有 item 这个元素</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> argsLength<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 遍历其他参数数组完毕</span>
      <span class="token comment">// j === argsLength 说明其他参数数组中都有 item 元素</span>
      <span class="token comment">// 则将其放入 result[] 中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">===</span> argsLength<span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Take the difference between one array and a number of other arrays.</span>
  <span class="token comment">// Only the elements present in just the first array will remain.</span>
  <span class="token comment">// _.difference(array, *others)</span>
  <span class="token comment">// Similar to without, but returns the values from array that are not present in the other arrays.</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.difference([1, 2, 3, 4, 5], [5, 2, 10]);</span>
  <span class="token comment">// =&gt; [1, 3, 4]</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 剔除 array 数组中在 others 数组中出现的元素</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">difference</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 将 others 数组展开一层</span>
    <span class="token comment">// rest[] 保存展开后的元素组成的数组</span>
    <span class="token comment">// strict 参数为 true</span>
    <span class="token comment">// 不可以这样用 _.difference([1, 2, 3, 4, 5], [5, 2], 10);</span>
    <span class="token comment">// 10 就会取不到</span>
    <span class="token keyword">var</span> rest <span class="token operator">=</span> <span class="token function">flatten</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 array，过滤</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 value 存在在 rest 中，则过滤掉</span>
      <span class="token keyword">return</span> <span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>rest<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Zip together multiple lists into a single array -- elements that share</span>
  <span class="token comment">// an index go together.</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.zip(['moe', 'larry', 'curly'], [30, 40, 50], [true, false, false]);</span>
  <span class="token comment">// =&gt; [[&quot;moe&quot;, 30, true], [&quot;larry&quot;, 40, false], [&quot;curly&quot;, 50, false]]</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 将多个数组中相同位置的元素归类</span>
  <span class="token comment">// 返回一个数组</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">zip</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">unzip</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Complement of _.zip. Unzip accepts an array of arrays and groups</span>
  <span class="token comment">// each array's elements on shared indices</span>
  <span class="token comment">// The opposite of zip. Given an array of arrays,</span>
  <span class="token comment">// returns a series of new arrays,</span>
  <span class="token comment">// the first of which contains all of the first elements in the input arrays,</span>
  <span class="token comment">// the second of which contains all of the second elements, and so on.</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.unzip([[&quot;moe&quot;, 30, true], [&quot;larry&quot;, 40, false], [&quot;curly&quot;, 50, false]]);</span>
  <span class="token comment">// =&gt; [['moe', 'larry', 'curly'], [30, 40, 50], [true, false, false]]</span>
  <span class="token comment">// ===== //</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">unzip</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token punctuation">(</span>array <span class="token operator">&amp;&amp;</span> _<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> getLength<span class="token punctuation">)</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">pluck</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Converts lists into objects. Pass either a single array of `[key, value]`</span>
  <span class="token comment">// pairs, or two parallel arrays of the same length -- one of keys, and one of</span>
  <span class="token comment">// the corresponding values.</span>
  <span class="token comment">// 将数组转化为对象</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">object</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">list<span class="token punctuation">,</span> values</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>values<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">[</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">[</span>list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> list<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Generator function to create the findIndex and findLastIndex functions</span>
  <span class="token comment">// (dir === 1) =&gt; 从前往后找</span>
  <span class="token comment">// (dir === -1) =&gt; 从后往前找</span>
  <span class="token keyword">function</span> <span class="token function">createPredicateIndexFinder</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 经典闭包</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">var</span> length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 根据 dir 变量来确定数组遍历的起始位置</span>
      <span class="token keyword">var</span> index <span class="token operator">=</span> dir <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> index <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index <span class="token operator">+=</span> dir<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 找到第一个符合条件的元素</span>
        <span class="token comment">// 并返回下标值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">,</span> index<span class="token punctuation">,</span> array<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> index<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Returns the first index on an array-like that passes a predicate test</span>
  <span class="token comment">// 从前往后找到数组中 `第一个满足条件` 的元素，并返回下标值</span>
  <span class="token comment">// 没找到返回 -1</span>
  <span class="token comment">// _.findIndex(array, predicate, [context])</span>
  _<span class="token punctuation">.</span>findIndex <span class="token operator">=</span> <span class="token function">createPredicateIndexFinder</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 从后往前找到数组中 `第一个满足条件` 的元素，并返回下标值</span>
  <span class="token comment">// 没找到返回 -1</span>
  <span class="token comment">// _.findLastIndex(array, predicate, [context])</span>
  _<span class="token punctuation">.</span>findLastIndex <span class="token operator">=</span> <span class="token function">createPredicateIndexFinder</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Use a comparator function to figure out the smallest index at which</span>
  <span class="token comment">// an object should be inserted so as to maintain order. Uses binary search.</span>
  <span class="token comment">// The iteratee may also be the string name of the property to sort by (eg. length).</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.sortedIndex([10, 20, 30, 40, 50], 35);</span>
  <span class="token comment">// =&gt; 3</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// var stooges = [{name: 'moe', age: 40}, {name: 'curly', age: 60}];</span>
  <span class="token comment">// _.sortedIndex(stooges, {name: 'larry', age: 50}, 'age');</span>
  <span class="token comment">// =&gt; 1</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 二分查找</span>
  <span class="token comment">// 将一个元素插入已排序的数组</span>
  <span class="token comment">// 返回该插入的位置下标</span>
  <span class="token comment">// _.sortedIndex(list, value, [iteratee], [context])</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">sortedIndex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注意 cb 方法</span>
    <span class="token comment">// iteratee 为空 || 为 String 类型（key 值）时会返回不同方法</span>
    iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 经过迭代函数计算的值</span>
    <span class="token comment">// 可打印 iteratee 出来看看</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> low <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
      high <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 二分查找</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>low <span class="token operator">&lt;</span> high<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> mid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>low <span class="token operator">+</span> high<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">iteratee</span><span class="token punctuation">(</span>array<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> value<span class="token punctuation">)</span> low <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">else</span> high <span class="token operator">=</span> mid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> low<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Generator function to create the indexOf and lastIndexOf functions</span>
  <span class="token comment">// _.indexOf = createIndexFinder(1, _.findIndex, _.sortedIndex);</span>
  <span class="token comment">// _.lastIndexOf = createIndexFinder(-1, _.findLastIndex);</span>
  <span class="token keyword">function</span> <span class="token function">createIndexFinder</span><span class="token punctuation">(</span><span class="token parameter">dir<span class="token punctuation">,</span> predicateFind<span class="token punctuation">,</span> sortedIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// API 调用形式</span>
    <span class="token comment">// _.indexOf(array, value, [isSorted])</span>
    <span class="token comment">// _.indexOf(array, value, [fromIndex])</span>
    <span class="token comment">// _.lastIndexOf(array, value, [fromIndex])</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> item<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> <span class="token function">getLength</span><span class="token punctuation">(</span>array<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果 idx 为 Number 类型</span>
      <span class="token comment">// 则规定查找位置的起始点</span>
      <span class="token comment">// 那么第三个参数不是 [isSorted]</span>
      <span class="token comment">// 所以不能用二分查找优化了</span>
      <span class="token comment">// 只能遍历查找</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> idx <span class="token operator">==</span> <span class="token string">'number'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dir <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 正向查找</span>
          <span class="token comment">// 重置查找的起始位置</span>
          i <span class="token operator">=</span> idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> idx <span class="token punctuation">:</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> length<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token comment">// 反向查找</span>
          <span class="token comment">// 如果是反向查找，重置 length 属性值</span>
          length <span class="token operator">=</span> idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>idx <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token punctuation">:</span> idx <span class="token operator">+</span> length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sortedIndex <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&amp;&amp;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 能用二分查找加速的条件</span>
        <span class="token comment">// 有序 &amp; idx !== 0 &amp;&amp; length !== 0</span>

        <span class="token comment">// 用 _.sortIndex 找到有序数组中 item 正好插入的位置</span>
        idx <span class="token operator">=</span> <span class="token function">sortedIndex</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 如果正好插入的位置的值和 item 刚好相等</span>
        <span class="token comment">// 说明该位置就是 item 第一次出现的位置</span>
        <span class="token comment">// 返回下标</span>
        <span class="token comment">// 否则即是没找到，返回 -1</span>
        <span class="token keyword">return</span> array<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">===</span> item <span class="token operator">?</span> idx <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 特判，如果要查找的元素是 NaN 类型</span>
      <span class="token comment">// 如果 item !== item</span>
      <span class="token comment">// 那么 item =&gt; NaN</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>item <span class="token operator">!==</span> item<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        idx <span class="token operator">=</span> <span class="token function">predicateFind</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>array<span class="token punctuation">,</span> i<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span>isNaN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">?</span> idx <span class="token operator">+</span> i <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// O(n) 遍历数组</span>
      <span class="token comment">// 寻找和 item 相同的元素</span>
      <span class="token comment">// 特判排除了 item 为 NaN 的情况</span>
      <span class="token comment">// 可以放心地用 `===` 来判断是否相等了</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>
        idx <span class="token operator">=</span> dir <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> i <span class="token punctuation">:</span> length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&lt;</span> length<span class="token punctuation">;</span>
        idx <span class="token operator">+=</span> dir
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">===</span> item<span class="token punctuation">)</span> <span class="token keyword">return</span> idx<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Return the position of the first occurrence of an item in an array,</span>
  <span class="token comment">// or -1 if the item is not included in the array.</span>
  <span class="token comment">// If the array is large and already in sort order, pass `true`</span>
  <span class="token comment">// for **isSorted** to use binary search.</span>
  <span class="token comment">// _.indexOf(array, value, [isSorted])</span>
  <span class="token comment">// 找到数组 array 中 value 第一次出现的位置</span>
  <span class="token comment">// 并返回其下标值</span>
  <span class="token comment">// 如果数组有序，则第三个参数可以传入 true</span>
  <span class="token comment">// 这样算法效率会更高（二分查找）</span>
  <span class="token comment">// [isSorted] 参数表示数组是否有序</span>
  <span class="token comment">// 同时第三个参数也可以表示 [fromIndex] （见下面的 _.lastIndexOf）</span>
  _<span class="token punctuation">.</span>indexOf <span class="token operator">=</span> <span class="token function">createIndexFinder</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span>findIndex<span class="token punctuation">,</span> _<span class="token punctuation">.</span>sortedIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 和 _indexOf 相似</span>
  <span class="token comment">// 反序查找</span>
  <span class="token comment">// _.lastIndexOf(array, value, [fromIndex])</span>
  <span class="token comment">// [fromIndex] 参数表示从倒数第几个开始往前找</span>
  _<span class="token punctuation">.</span>lastIndexOf <span class="token operator">=</span> <span class="token function">createIndexFinder</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> _<span class="token punctuation">.</span>findLastIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Generate an integer Array containing an arithmetic progression. A port of</span>
  <span class="token comment">// the native Python `range()` function. See</span>
  <span class="token comment">// [the Python documentation](http://docs.python.org/library/functions.html#range).</span>
  <span class="token comment">// 返回某一个范围内的数组成的数组</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">range</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">start<span class="token punctuation">,</span> stop<span class="token punctuation">,</span> step</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stop <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      stop <span class="token operator">=</span> start <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
      start <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    step <span class="token operator">=</span> step <span class="token operator">||</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回数组的长度</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">(</span>stop <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> step<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回的数组</span>
    <span class="token keyword">var</span> range <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">,</span> start <span class="token operator">+=</span> step<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      range<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> start<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> range<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Function (ahem) Functions</span>
  <span class="token comment">// 函数的扩展方法</span>
  <span class="token comment">// 共 14 个扩展方法</span>
  <span class="token comment">// ------------------</span>

  <span class="token comment">// Determines whether to execute a function as a constructor</span>
  <span class="token comment">// or a normal function with the provided arguments</span>
  <span class="token keyword">var</span> <span class="token function-variable function">executeBound</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
    <span class="token parameter">sourceFunc<span class="token punctuation">,</span>
    boundFunc<span class="token punctuation">,</span>
    context<span class="token punctuation">,</span>
    callingContext<span class="token punctuation">,</span>
    args</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 非 new 调用 _.bind 返回的方法（即 bound）</span>
    <span class="token comment">// callingContext 不是 boundFunc 的一个实例</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>callingContext <span class="token keyword">instanceof</span> <span class="token class-name">boundFunc</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">sourceFunc</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是用 new 调用 _.bind 返回的方法</span>

    <span class="token comment">// self 为 sourceFunc 的实例，继承了它的原型链</span>
    <span class="token comment">// self 理论上是一个空对象（还没赋值），但是有原型链</span>
    <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token function">baseCreate</span><span class="token punctuation">(</span>sourceFunc<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 用 new 生成一个构造函数的实例</span>
    <span class="token comment">// 正常情况下是没有返回值的，即 result 值为 undefined</span>
    <span class="token comment">// 如果构造函数有返回值</span>
    <span class="token comment">// 如果返回值是对象（非 null），则 new 的结果返回这个对象</span>
    <span class="token comment">// 否则返回实例</span>
    <span class="token comment">// @see http://www.cnblogs.com/zichi/p/4392944.html</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">sourceFunc</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果构造函数返回了对象</span>
    <span class="token comment">// 则 new 的结果是这个对象</span>
    <span class="token comment">// 返回这个对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token comment">// 否则返回 self</span>
    <span class="token comment">// var result = sourceFunc.apply(self, args);</span>
    <span class="token comment">// self 对象当做参数传入</span>
    <span class="token comment">// 会直接改变值</span>
    <span class="token keyword">return</span> self<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a function bound to a given object (assigning `this`, and arguments,</span>
  <span class="token comment">// optionally). Delegates to **ECMAScript 5**'s native `Function.bind` if</span>
  <span class="token comment">// available.</span>
  <span class="token comment">// ES5 bind 方法的扩展（polyfill）</span>
  <span class="token comment">// 将 func 中的 this 指向 context（对象）</span>
  <span class="token comment">// _.bind(function, object, *arguments)</span>
  <span class="token comment">// 可选的 arguments 参数会被当作 func 的参数传入</span>
  <span class="token comment">// func 在调用时，会优先用 arguments 参数，然后使用 _.bind 返回方法所传入的参数</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">bind</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果浏览器支持 ES5 bind 方法，并且 func 上的 bind 方法没有被重写</span>
    <span class="token comment">// 则优先使用原生的 bind 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeBind <span class="token operator">&amp;&amp;</span> func<span class="token punctuation">.</span>bind <span class="token operator">===</span> nativeBind<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token function">nativeBind</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果传入的参数 func 不是方法，则抛出错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'Bind must be called on a function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// polyfill</span>
    <span class="token comment">// 经典闭包，函数返回函数</span>
    <span class="token comment">// args 获取优先使用的参数</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">bound</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// args.concat(slice.call(arguments))</span>
      <span class="token comment">// 最终函数的实际调用参数由两部分组成</span>
      <span class="token comment">// 一部分是传入 _.bind 的参数（会被优先调用）</span>
      <span class="token comment">// 另一部分是传入 bound（_.bind 所返回方法）的参数</span>
      <span class="token keyword">return</span> <span class="token function">executeBound</span><span class="token punctuation">(</span>
        func<span class="token punctuation">,</span>
        bound<span class="token punctuation">,</span>
        context<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">,</span>
        args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> bound<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Partially apply a function by creating a version that has had some of its</span>
  <span class="token comment">// arguments pre-filled, without changing its dynamic `this` context. _ acts</span>
  <span class="token comment">// as a placeholder, allowing any combination of arguments to be pre-filled.</span>
  <span class="token comment">// _.partial(function, *arguments)</span>
  <span class="token comment">// _.partial 能返回一个方法</span>
  <span class="token comment">// pre-fill 该方法的一些参数</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">partial</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提取希望 pre-fill 的参数</span>
    <span class="token comment">// 如果传入的是 _，则这个位置的参数暂时空着，等待手动填入</span>
    <span class="token keyword">var</span> boundArgs <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">bound</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> position <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        length <span class="token operator">=</span> boundArgs<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
      <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果该位置的参数为 _，则用 bound 方法的参数填充这个位置</span>
        <span class="token comment">// args 为调用 _.partial 方法的 pre-fill 的参数 &amp; bound 方法的 arguments</span>
        args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> boundArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> _ <span class="token operator">?</span> arguments<span class="token punctuation">[</span>position<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token punctuation">:</span> boundArgs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// bound 方法还有剩余的 arguments，添上去</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>position <span class="token operator">&lt;</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">)</span> args<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span>position<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token function">executeBound</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> bound<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> bound<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Bind a number of an object's methods to that object. Remaining arguments</span>
  <span class="token comment">// are the method names to be bound. Useful for ensuring that all callbacks</span>
  <span class="token comment">// defined on an object belong to it.</span>
  <span class="token comment">// 指定一系列方法（methodNames）中的 this 指向（object）</span>
  <span class="token comment">// _.bindAll(object, *methodNames)</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">bindAll</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> i<span class="token punctuation">,</span>
      length <span class="token operator">=</span> arguments<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      key<span class="token punctuation">;</span>

    <span class="token comment">// 如果只传入了一个参数（obj），没有传入 methodNames，则报错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'bindAll must be passed function names'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 methodNames</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      key <span class="token operator">=</span> arguments<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 逐个绑定</span>
      obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Memoize an expensive function by storing its results.</span>
  <span class="token comment">//「记忆化」，存储中间运算结果，提高效率</span>
  <span class="token comment">// 参数 hasher 是个 function，用来计算 key</span>
  <span class="token comment">// 如果传入了 hasher，则用 hasher 来计算 key</span>
  <span class="token comment">// 否则用 key 参数直接当 key（即 memoize 方法传入的第一个参数）</span>
  <span class="token comment">// _.memoize(function, [hashFunction])</span>
  <span class="token comment">// 适用于需要大量重复求值的场景</span>
  <span class="token comment">// 比如递归求解菲波那切数</span>
  <span class="token comment">// @http://www.jameskrob.com/memoize.html</span>
  <span class="token comment">// create hash for storing &quot;expensive&quot; function outputs</span>
  <span class="token comment">// run expensive function</span>
  <span class="token comment">// check whether function has already been run with given arguments via hash lookup</span>
  <span class="token comment">// if false - run function, and store output in hash</span>
  <span class="token comment">// if true, return output stored in hash</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">memoize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> hasher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">memoize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 储存变量，方便使用</span>
      <span class="token keyword">var</span> cache <span class="token operator">=</span> memoize<span class="token punctuation">.</span>cache<span class="token punctuation">;</span>

      <span class="token comment">// 求 key</span>
      <span class="token comment">// 如果传入了 hasher，则用 hasher 函数来计算 key</span>
      <span class="token comment">// 否则用 参数 key（即 memoize 方法传入的第一个参数）当 key</span>
      <span class="token keyword">var</span> address <span class="token operator">=</span> <span class="token string">''</span> <span class="token operator">+</span> <span class="token punctuation">(</span>hasher <span class="token operator">?</span> <span class="token function">hasher</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span> <span class="token punctuation">:</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果这个 key 还没被 hash 过（还没求过值）</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>cache<span class="token punctuation">,</span> address<span class="token punctuation">)</span><span class="token punctuation">)</span> cache<span class="token punctuation">[</span>address<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 返回</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">[</span>address<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// cache 对象被当做 key-value 键值对缓存中间运算结果</span>
    memoize<span class="token punctuation">.</span>cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回一个函数（经典闭包）</span>
    <span class="token keyword">return</span> memoize<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Delays a function for the given number of milliseconds, and then calls</span>
  <span class="token comment">// it with the arguments supplied.</span>
  <span class="token comment">// 延迟触发某方法</span>
  <span class="token comment">// _.delay(function, wait, *arguments)</span>
  <span class="token comment">//  如果传入了 arguments 参数，则会被当作 func 的参数在触发时调用</span>
  <span class="token comment">// 其实是封装了「延迟触发某方法」，使其复用</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">delay</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 获取 *arguments</span>
    <span class="token comment">// 是 func 函数所需要的参数</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 将参数赋予 func 函数</span>
      <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Defers a function, scheduling it to run after the current call stack has</span>
  <span class="token comment">// cleared.</span>
  <span class="token comment">// 和 setTimeout(func, 0) 相似（源码看来似乎应该是 setTimeout(func, 1)）</span>
  <span class="token comment">// _.defer(function, *arguments)</span>
  <span class="token comment">// 如果传入 *arguments，会被当做参数，和 _.delay 调用方式类似（少了第二个参数）</span>
  <span class="token comment">// 其实核心还是调用了 _.delay 方法，但第二个参数（wait 参数）设置了默认值为 1</span>
  <span class="token comment">// 如何使得方法能设置默认值？用 _.partial 方法</span>
  _<span class="token punctuation">.</span>defer <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">partial</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>delay<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function, that, when invoked, will only be triggered at most once</span>
  <span class="token comment">// during a given window of time. Normally, the throttled function will run</span>
  <span class="token comment">// as much as it can, without ever going more than once per `wait` duration;</span>
  <span class="token comment">// but if you'd like to disable the execution on the leading edge, pass</span>
  <span class="token comment">// `{leading: false}`. To disable execution on the trailing edge, ditto.</span>
  <span class="token comment">// 函数节流（如果有连续事件响应，则每间隔一定时间段触发）</span>
  <span class="token comment">// 每间隔 wait(Number) milliseconds 触发一次 func 方法</span>
  <span class="token comment">// 如果 options 参数传入 {leading: false}</span>
  <span class="token comment">// 那么不会马上触发（等待 wait milliseconds 后第一次触发 func）</span>
  <span class="token comment">// 如果 options 参数传入 {trailing: false}</span>
  <span class="token comment">// 那么最后一次回调不会被触发</span>
  <span class="token comment">// **Notice: options 不能同时设置 leading 和 trailing 为 false**</span>
  <span class="token comment">// 示例：</span>
  <span class="token comment">// var throttled = _.throttle(updatePosition, 100);</span>
  <span class="token comment">// $(window).scroll(throttled);</span>
  <span class="token comment">// 调用方式（注意看 A 和 B console.log 打印的位置）：</span>
  <span class="token comment">// _.throttle(function, wait, [options])</span>
  <span class="token comment">// sample 1: _.throttle(function(){}, 1000)</span>
  <span class="token comment">// print: A, B, B, B ...</span>
  <span class="token comment">// sample 2: _.throttle(function(){}, 1000, {leading: false})</span>
  <span class="token comment">// print: B, B, B, B ...</span>
  <span class="token comment">// sample 3: _.throttle(function(){}, 1000, {trailing: false})</span>
  <span class="token comment">// print: A, A, A, A ...</span>
  <span class="token comment">// ----------------------------------------- //</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">throttle</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> context<span class="token punctuation">,</span> args<span class="token punctuation">,</span> result<span class="token punctuation">;</span>

    <span class="token comment">// setTimeout 的 handler</span>
    <span class="token keyword">var</span> timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记时间戳</span>
    <span class="token comment">// 上一次执行回调的时间戳</span>
    <span class="token keyword">var</span> previous <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果没有传入 options 参数</span>
    <span class="token comment">// 则将 options 参数置为空对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">)</span> options <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">later</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 options.leading === false</span>
      <span class="token comment">// 则每次触发回调后将 previous 置为 0</span>
      <span class="token comment">// 否则置为当前时间戳</span>
      previous <span class="token operator">=</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token comment">// console.log('B')</span>
      result <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 这里的 timeout 变量一定是 null 了吧</span>
      <span class="token comment">// 是否没有必要进行判断？</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 以滚轮事件为例（scroll）</span>
    <span class="token comment">// 每次触发滚轮事件即执行这个返回的方法</span>
    <span class="token comment">// _.throttle 方法返回的函数</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 记录当前时间戳</span>
      <span class="token keyword">var</span> now <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 第一次执行回调（此时 previous 为 0，之后 previous 值为上一次时间戳）</span>
      <span class="token comment">// 并且如果程序设定第一个回调不是立即执行的（options.leading === false）</span>
      <span class="token comment">// 则将 previous 值（表示上次执行的时间戳）设为 now 的时间戳（第一次触发时）</span>
      <span class="token comment">// 表示刚执行过，这次就不用执行了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>previous <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>leading <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> previous <span class="token operator">=</span> now<span class="token punctuation">;</span>

      <span class="token comment">// 距离下次触发 func 还需要等待的时间</span>
      <span class="token keyword">var</span> remaining <span class="token operator">=</span> wait <span class="token operator">-</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> previous<span class="token punctuation">)</span><span class="token punctuation">;</span>
      context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>

      <span class="token comment">// 要么是到了间隔时间了，随即触发方法（remaining &lt;= 0）</span>
      <span class="token comment">// 要么是没有传入 {leading: false}，且第一次触发回调，即立即触发</span>
      <span class="token comment">// 此时 previous 为 0，wait - (now - previous) 也满足 &lt;= 0</span>
      <span class="token comment">// 之后便会把 previous 值迅速置为 now</span>
      <span class="token comment">// ========= //</span>
      <span class="token comment">// remaining &gt; wait，表示客户端系统时间被调整过</span>
      <span class="token comment">// 则马上执行 func 函数</span>
      <span class="token comment">// @see https://blog.coding.net/blog/the-difference-between-throttle-and-debounce-in-underscorejs</span>
      <span class="token comment">// ========= //</span>

      <span class="token comment">// console.log(remaining) 可以打印出来看看</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>remaining <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> remaining <span class="token operator">&gt;</span> wait<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 解除引用，防止内存泄露</span>
          timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 重置前一次触发的时间戳</span>
        previous <span class="token operator">=</span> now<span class="token punctuation">;</span>

        <span class="token comment">// 触发方法</span>
        <span class="token comment">// result 为该方法返回值</span>
        <span class="token comment">// console.log('A')</span>
        result <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 引用置为空，防止内存泄露</span>
        <span class="token comment">// 感觉这里的 timeout 肯定是 null 啊？这个 if 判断没必要吧？</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>trailing <span class="token operator">!==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 最后一次需要触发的情况</span>
        <span class="token comment">// 如果已经存在一个定时器，则不会进入该 if 分支</span>
        <span class="token comment">// 如果 {trailing: false}，即最后一次不需要触发了，也不会进入这个分支</span>
        <span class="token comment">// 间隔 remaining milliseconds 后触发 later 方法</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 回调返回值</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function, that, as long as it continues to be invoked, will not</span>
  <span class="token comment">// be triggered. The function will be called after it stops being called for</span>
  <span class="token comment">// N milliseconds. If `immediate` is passed, trigger the function on the</span>
  <span class="token comment">// leading edge, instead of the trailing.</span>
  <span class="token comment">// 函数去抖（连续事件触发结束后只触发一次）</span>
  <span class="token comment">// sample 1: _.debounce(function(){}, 1000)</span>
  <span class="token comment">// 连续事件结束后的 1000ms 后触发</span>
  <span class="token comment">// sample 1: _.debounce(function(){}, 1000, true)</span>
  <span class="token comment">// 连续事件触发后立即触发（此时会忽略第二个参数）</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wait<span class="token punctuation">,</span> immediate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> timeout<span class="token punctuation">,</span> args<span class="token punctuation">,</span> context<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> result<span class="token punctuation">;</span>

    <span class="token keyword">var</span> <span class="token function-variable function">later</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 定时器设置的回调 later 方法的触发时间，和连续事件触发的最后一次时间戳的间隔</span>
      <span class="token comment">// 如果间隔为 wait（或者刚好大于 wait），则触发事件</span>
      <span class="token keyword">var</span> last <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> timestamp<span class="token punctuation">;</span>

      <span class="token comment">// 时间间隔 last 在 [0, wait) 中</span>
      <span class="token comment">// 还没到触发的点，则继续设置定时器</span>
      <span class="token comment">// last 值应该不会小于 0 吧？</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>last <span class="token operator">&lt;</span> wait <span class="token operator">&amp;&amp;</span> last <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> wait <span class="token operator">-</span> last<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 到了可以触发的时间点</span>
        timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 可以触发了</span>
        <span class="token comment">// 并且不是设置为立即触发的</span>
        <span class="token comment">// 因为如果是立即触发（callNow），也会进入这个回调中</span>
        <span class="token comment">// 主要是为了将 timeout 值置为空，使之不影响下次连续事件的触发</span>
        <span class="token comment">// 如果不是立即执行，随即执行 func 方法</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 执行 func 函数</span>
          result <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// 这里的 timeout 一定是 null 了吧</span>
          <span class="token comment">// 感觉这个判断多余了</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span> context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 嗯，闭包返回的函数，是可以传入参数的</span>
    <span class="token comment">// 也是 DOM 事件所触发的回调函数</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 可以指定 this 指向</span>
      context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>

      <span class="token comment">// 每次触发函数，更新时间戳</span>
      <span class="token comment">// later 方法中取 last 值时用到该变量</span>
      <span class="token comment">// 判断距离上次触发事件是否已经过了 wait seconds 了</span>
      <span class="token comment">// 即我们需要距离最后一次事件触发 wait seconds 后触发这个回调方法</span>
      timestamp <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 立即触发需要满足两个条件</span>
      <span class="token comment">// immediate 参数为 true，并且 timeout 还没设置</span>
      <span class="token comment">// immediate 参数为 true 是显而易见的</span>
      <span class="token comment">// 如果去掉 !timeout 的条件，就会一直触发，而不是触发一次</span>
      <span class="token comment">// 因为第一次触发后已经设置了 timeout，所以根据 timeout 是否为空可以判断是否是首次触发</span>
      <span class="token keyword">var</span> callNow <span class="token operator">=</span> immediate <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timeout<span class="token punctuation">;</span>

      <span class="token comment">// 设置 wait seconds 后触发 later 方法</span>
      <span class="token comment">// 无论是否 callNow（如果是 callNow，也进入 later 方法，去 later 方法中判断是否执行相应回调函数）</span>
      <span class="token comment">// 在某一段的连续触发中，只会在第一次触发时进入这个 if 分支中</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout<span class="token punctuation">)</span>
        <span class="token comment">// 设置了 timeout，所以以后不会进入这个 if 分支了</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>later<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果是立即触发</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callNow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// func 可能是有返回值的</span>
        result <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解除引用</span>
        context <span class="token operator">=</span> args <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns the first function passed as an argument to the second,</span>
  <span class="token comment">// allowing you to adjust arguments, run code before and after, and</span>
  <span class="token comment">// conditionally execute the original function.</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">wrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">func<span class="token punctuation">,</span> wrapper</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">partial</span><span class="token punctuation">(</span>wrapper<span class="token punctuation">,</span> func<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a negated version of the passed-in predicate.</span>
  <span class="token comment">// 返回一个 predicate 方法的对立方法</span>
  <span class="token comment">// 即该方法可以对原来的 predicate 迭代结果值取补集</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">negate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">predicate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">predicate</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function that is the composition of a list of functions, each</span>
  <span class="token comment">// consuming the return value of the function that follows.</span>
  <span class="token comment">// _.compose(*functions)</span>
  <span class="token comment">// var tmp = _.compose(f, g, h)</span>
  <span class="token comment">// tmp(args) =&gt; f(g(h(args)))</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">compose</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span> <span class="token comment">// funcs</span>
    <span class="token keyword">var</span> start <span class="token operator">=</span> args<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 倒序调用</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span>
      <span class="token keyword">var</span> result <span class="token operator">=</span> args<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 一个一个方法地执行</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> result <span class="token operator">=</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function that will only be executed on and after the Nth call.</span>
  <span class="token comment">// 第 times 触发执行 func（事实上之后的每次触发还是会执行 func）</span>
  <span class="token comment">// 有什么用呢？</span>
  <span class="token comment">// 如果有 N 个异步事件，所有异步执行完后执行该回调，即 func 方法（联想 eventproxy）</span>
  <span class="token comment">// _.after 会返回一个函数</span>
  <span class="token comment">// 当这个函数第 times 被执行的时候</span>
  <span class="token comment">// 触发 func 方法</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">after</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">times<span class="token punctuation">,</span> func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 函数被触发了 times 了，则执行 func 函数</span>
      <span class="token comment">// 事实上 times 次后如果函数继续被执行，也会触发 func</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>times <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function that will only be executed up to (but not including) the Nth call.</span>
  <span class="token comment">// 函数至多被调用 times - 1 次（(but not including) the Nth call）</span>
  <span class="token comment">// func 函数会触发 time - 1 次（Creates a version of the function that can be called no more than count times）</span>
  <span class="token comment">// func 函数有个返回值，前 time - 1 次触发的返回值都是将参数代入重新计算的</span>
  <span class="token comment">// 第 times 开始的返回值为第 times - 1 次时的返回值（不重新计算）</span>
  <span class="token comment">// The result of the last function call is memoized and returned when count has been reached.</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">before</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">times<span class="token punctuation">,</span> func</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> memo<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">--</span>times <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 缓存函数执行结果</span>
        memo <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// func 引用置为空，其实不置为空也用不到 func 了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>times <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> func <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token comment">// 前 times - 1 次触发，memo 都是分别计算返回</span>
      <span class="token comment">// 第 times 次开始，memo 值同 times - 1 次时的 memo</span>
      <span class="token keyword">return</span> memo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a function that will be executed at most one time, no matter how</span>
  <span class="token comment">// often you call it. Useful for lazy initialization.</span>
  <span class="token comment">// 函数至多只能被调用一次</span>
  <span class="token comment">// 适用于这样的场景，某些函数只能被初始化一次，不得不设置一个变量 flag</span>
  <span class="token comment">// 初始化后设置 flag 为 true，之后不断 check flag</span>
  <span class="token comment">// ====== //</span>
  <span class="token comment">// 其实是调用了 _.before 方法，并且将 times 参数设置为了默认值 2（也就是 func 至多能被调用 2 - 1 = 1 次）</span>
  _<span class="token punctuation">.</span>once <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">partial</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>before<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Object Functions</span>
  <span class="token comment">// 对象的扩展方法</span>
  <span class="token comment">// 共 38 个扩展方法</span>
  <span class="token comment">// ----------------</span>

  <span class="token comment">// Keys in IE &lt; 9 that won't be iterated by `for key in ...` and thus missed.</span>
  <span class="token comment">// IE &lt; 9 下 不能用 for key in ... 来枚举对象的某些 key</span>
  <span class="token comment">// 比如重写了对象的 `toString` 方法，这个 key 值就不能在 IE &lt; 9 下用 for in 枚举到</span>
  <span class="token comment">// IE &lt; 9，{toString: null}.propertyIsEnumerable('toString') 返回 false</span>
  <span class="token comment">// IE &lt; 9，重写的 `toString` 属性被认为不可枚举</span>
  <span class="token comment">// 据此可以判断是否在 IE &lt; 9 浏览器环境中</span>
  <span class="token keyword">var</span> hasEnumBug <span class="token operator">=</span> <span class="token operator">!</span><span class="token punctuation">{</span> toString<span class="token punctuation">:</span> <span class="token keyword">null</span> <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">propertyIsEnumerable</span><span class="token punctuation">(</span><span class="token string">'toString'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// IE &lt; 9 下不能用 for in 来枚举的 key 值集合</span>
  <span class="token comment">// 其实还有个 `constructor` 属性</span>
  <span class="token comment">// 个人觉得可能是 `constructor` 和其他属性不属于一类</span>
  <span class="token comment">// nonEnumerableProps[] 中都是方法</span>
  <span class="token comment">// 而 constructor 表示的是对象的构造函数</span>
  <span class="token comment">// 所以区分开来了</span>
  <span class="token keyword">var</span> nonEnumerableProps <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'valueOf'</span><span class="token punctuation">,</span>
    <span class="token string">'isPrototypeOf'</span><span class="token punctuation">,</span>
    <span class="token string">'toString'</span><span class="token punctuation">,</span>
    <span class="token string">'propertyIsEnumerable'</span><span class="token punctuation">,</span>
    <span class="token string">'hasOwnProperty'</span><span class="token punctuation">,</span>
    <span class="token string">'toLocaleString'</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// obj 为需要遍历键值对的对象</span>
  <span class="token comment">// keys 为键数组</span>
  <span class="token comment">// 利用 JavaScript 按值传递的特点</span>
  <span class="token comment">// 传入数组作为参数，能直接改变数组的值</span>
  <span class="token keyword">function</span> <span class="token function">collectNonEnumProps</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> keys</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> nonEnumIdx <span class="token operator">=</span> nonEnumerableProps<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">var</span> constructor <span class="token operator">=</span> obj<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>

    <span class="token comment">// 获取对象的原型</span>
    <span class="token comment">// 如果 obj 的 constructor 被重写</span>
    <span class="token comment">// 则 proto 变量为 Object.prototype</span>
    <span class="token comment">// 如果没有被重写</span>
    <span class="token comment">// 则为 obj.constructor.prototype</span>
    <span class="token keyword">var</span> proto <span class="token operator">=</span>
      <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>constructor<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> constructor<span class="token punctuation">.</span>prototype<span class="token punctuation">)</span> <span class="token operator">||</span> ObjProto<span class="token punctuation">;</span>

    <span class="token comment">// Constructor is a special case.</span>
    <span class="token comment">// `constructor` 属性需要特殊处理 (是否有必要？)</span>
    <span class="token comment">// see https://github.com/hanzichi/underscore-analysis/issues/3</span>
    <span class="token comment">// 如果 obj 有 `constructor` 这个 key</span>
    <span class="token comment">// 并且该 key 没有在 keys 数组中</span>
    <span class="token comment">// 存入 keys 数组</span>
    <span class="token keyword">var</span> prop <span class="token operator">=</span> <span class="token string">'constructor'</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> prop<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">)</span> keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 nonEnumerableProps 数组中的 keys</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>nonEnumIdx<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      prop <span class="token operator">=</span> nonEnumerableProps<span class="token punctuation">[</span>nonEnumIdx<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// prop in obj 应该肯定返回 true 吧？是否有判断必要？</span>
      <span class="token comment">// obj[prop] !== proto[prop] 判断该 key 是否来自于原型链</span>
      <span class="token comment">// 即是否重写了原型链上的属性</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>prop <span class="token keyword">in</span> obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">!==</span> proto<span class="token punctuation">[</span>prop<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> prop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Retrieve the names of an object's own properties.</span>
  <span class="token comment">// Delegates to **ECMAScript 5**'s native `Object.keys`</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.keys({one: 1, two: 2, three: 3});</span>
  <span class="token comment">// =&gt; [&quot;one&quot;, &quot;two&quot;, &quot;three&quot;]</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 返回一个对象的 keys 组成的数组</span>
  <span class="token comment">// 仅返回 own enumerable properties 组成的数组</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">keys</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 容错</span>
    <span class="token comment">// 如果传入的参数不是对象，则返回空数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果浏览器支持 ES5 Object.key() 方法</span>
    <span class="token comment">// 则优先使用该方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeKeys<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">nativeKeys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// own enumerable properties</span>
    <span class="token comment">// hasOwnProperty</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span> keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ahem, IE &lt; 9.</span>
    <span class="token comment">// IE &lt; 9 下不能用 for in 来枚举某些 key 值</span>
    <span class="token comment">// 传入 keys 数组为参数</span>
    <span class="token comment">// 因为 JavaScript 下函数参数按值传递</span>
    <span class="token comment">// 所以 keys 当做参数传入后会在 `collectNonEnumProps` 方法中改变值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasEnumBug<span class="token punctuation">)</span> <span class="token function">collectNonEnumProps</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> keys<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Retrieve all the property names of an object.</span>
  <span class="token comment">// 返回一个对象的 keys 数组</span>
  <span class="token comment">// 不仅仅是 own enumerable properties</span>
  <span class="token comment">// 还包括原型链上继承的属性</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">allKeys</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 容错</span>
    <span class="token comment">// 不是对象，则返回空数组</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> keys<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Ahem, IE &lt; 9.</span>
    <span class="token comment">// IE &lt; 9 下的 bug，同 _.keys 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasEnumBug<span class="token punctuation">)</span> <span class="token function">collectNonEnumProps</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> keys<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Retrieve the values of an object's properties.</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// _.values({one: 1, two: 2, three: 3});</span>
  <span class="token comment">// =&gt; [1, 2, 3]</span>
  <span class="token comment">// ===== //</span>
  <span class="token comment">// 将一个对象的所有 values 值放入数组中</span>
  <span class="token comment">// 仅限 own properties 上的 values</span>
  <span class="token comment">// 不包括原型链上的</span>
  <span class="token comment">// 并返回该数组</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">values</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 仅包括 own properties</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">var</span> values <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      values<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> values<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns the results of applying the iteratee to each element of the object</span>
  <span class="token comment">// In contrast to _.map it returns an object</span>
  <span class="token comment">// 跟 _.map 方法很像</span>
  <span class="token comment">// 但是是专门为对象服务的 map 方法</span>
  <span class="token comment">// 迭代函数改变对象的 values 值</span>
  <span class="token comment">// 返回对象副本</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">mapObject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 迭代函数</span>
    <span class="token comment">// 对每个键值对进行迭代</span>
    iteratee <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
      results <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 对象副本，该方法返回的对象</span>
      currentKey<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentKey <span class="token operator">=</span> keys<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// key 值不变</span>
      <span class="token comment">// 对每个 value 值用迭代函数迭代</span>
      <span class="token comment">// 返回经过函数运算后的值</span>
      results<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>currentKey<span class="token punctuation">]</span><span class="token punctuation">,</span> currentKey<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> results<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Convert an object into a list of `[key, value]` pairs.</span>
  <span class="token comment">// 将一个对象转换为元素为 [key, value] 形式的数组</span>
  <span class="token comment">// _.pairs({one: 1, two: 2, three: 3});</span>
  <span class="token comment">// =&gt; [[&quot;one&quot;, 1], [&quot;two&quot;, 2], [&quot;three&quot;, 3]]</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">pairs</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">var</span> pairs <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      pairs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pairs<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Invert the keys and values of an object. The values must be serializable.</span>
  <span class="token comment">// 将一个对象的 key-value 键值对颠倒</span>
  <span class="token comment">// 即原来的 key 为 value 值，原来的 value 值为 key 值</span>
  <span class="token comment">// 需要注意的是，value 值不能重复（不然后面的会覆盖前面的）</span>
  <span class="token comment">// 且新构造的对象符合对象构造规则</span>
  <span class="token comment">// 并且返回新构造的对象</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">invert</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的新的对象</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result<span class="token punctuation">[</span>obj<span class="token punctuation">[</span>keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a sorted list of the function names available on the object.</span>
  <span class="token comment">// Aliased as `methods`</span>
  <span class="token comment">// 传入一个对象</span>
  <span class="token comment">// 遍历该对象的键值对（包括 own properties 以及 原型链上的）</span>
  <span class="token comment">// 如果某个 value 的类型是方法（function），则将该 key 存入数组</span>
  <span class="token comment">// 将该数组排序后返回</span>
  _<span class="token punctuation">.</span>functions <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">methods</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回的数组</span>
    <span class="token keyword">var</span> names <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// if IE &lt; 9</span>
    <span class="token comment">// 且对象重写了 `nonEnumerableProps` 数组中的某些方法</span>
    <span class="token comment">// 那么这些方法名是不会被返回的</span>
    <span class="token comment">// 可见放弃了 IE &lt; 9 可能对 `toString` 等方法的重写支持</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> key <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果某个 key 对应的 value 值类型是函数</span>
      <span class="token comment">// 则将这个 key 值存入数组</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> names<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回排序后的数组</span>
    <span class="token keyword">return</span> names<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Extend a given object with all the properties in passed-in object(s).</span>
  <span class="token comment">// extend_.extend(destination, *sources)</span>
  <span class="token comment">// Copy all of the properties in the source objects over to the destination object</span>
  <span class="token comment">// and return the destination object</span>
  <span class="token comment">// It's in-order, so the last source will override properties of the same name in previous arguments.</span>
  <span class="token comment">// 将几个对象上（第二个参数开始，根据参数而定）的所有键值对添加到 destination 对象（第一个参数）上</span>
  <span class="token comment">// 因为 key 值可能会相同，所以后面的（键值对）可能会覆盖前面的</span>
  <span class="token comment">// 参数个数 &gt;= 1</span>
  _<span class="token punctuation">.</span>extend <span class="token operator">=</span> <span class="token function">createAssigner</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>allKeys<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Assigns a given object with all the own properties in the passed-in object(s)</span>
  <span class="token comment">// (https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object/assign)</span>
  <span class="token comment">// 跟 extend 方法类似，但是只把 own properties 拷贝给第一个参数对象</span>
  <span class="token comment">// 只继承 own properties 的键值对</span>
  <span class="token comment">// 参数个数 &gt;= 1</span>
  _<span class="token punctuation">.</span>extendOwn <span class="token operator">=</span> _<span class="token punctuation">.</span>assign <span class="token operator">=</span> <span class="token function">createAssigner</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>keys<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns the first key on an object that passes a predicate test</span>
  <span class="token comment">// 跟数组方法的 _.findIndex 类似</span>
  <span class="token comment">// 找到对象的键值对中第一个满足条件的键值对</span>
  <span class="token comment">// 并返回该键值对 key 值</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">findKey</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> predicate<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    predicate <span class="token operator">=</span> <span class="token function">cb</span><span class="token punctuation">(</span>predicate<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span>
      key<span class="token punctuation">;</span>
    <span class="token comment">// 遍历键值对</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 符合条件，直接返回 key 值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">predicate</span><span class="token punctuation">(</span>obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a copy of the object only containing the whitelisted properties.</span>
  <span class="token comment">// 根据一定的需求（key 值，或者通过 predicate 函数返回真假）</span>
  <span class="token comment">// 返回拥有一定键值对的对象副本</span>
  <span class="token comment">// 第二个参数可以是一个 predicate 函数</span>
  <span class="token comment">// 也可以是 &gt;= 0 个 key</span>
  <span class="token comment">// _.pick(object, *keys)</span>
  <span class="token comment">// Return a copy of the object</span>
  <span class="token comment">// filtered to only have values for the whitelisted keys (or array of valid keys)</span>
  <span class="token comment">// Alternatively accepts a predicate indicating which keys to pick.</span>
  <span class="token comment">/*
  _.pick({name: 'moe', age: 50, userid: 'moe1'}, 'name', 'age');
  =&gt; {name: 'moe', age: 50}
  _.pick({name: 'moe', age: 50, userid: 'moe1'}, ['name', 'age']);
  =&gt; {name: 'moe', age: 50}
  _.pick({name: 'moe', age: 50, userid: 'moe1'}, function(value, key, object) {
    return _.isNumber(value);
  });
  =&gt; {age: 50}
  */</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">pick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> oiteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// result 为返回的对象副本</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      obj <span class="token operator">=</span> object<span class="token punctuation">,</span>
      iteratee<span class="token punctuation">,</span>
      keys<span class="token punctuation">;</span>

    <span class="token comment">// 容错</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    <span class="token comment">// 如果第二个参数是函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>oiteratee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">allKeys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      iteratee <span class="token operator">=</span> <span class="token function">optimizeCb</span><span class="token punctuation">(</span>oiteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果第二个参数不是函数</span>
      <span class="token comment">// 则后面的 keys 可能是数组</span>
      <span class="token comment">// 也可能是连续的几个并列的参数</span>
      <span class="token comment">// 用 flatten 将它们展开</span>
      keys <span class="token operator">=</span> <span class="token function">flatten</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 也转为 predicate 函数判断形式</span>
      <span class="token comment">// 将指定 key 转化为 predicate 函数</span>
      <span class="token function-variable function">iteratee</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> key <span class="token keyword">in</span> obj<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      obj <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 满足条件</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">iteratee</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> key<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> result<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a copy of the object without the blacklisted properties.</span>
  <span class="token comment">// 跟 _.pick 方法相对</span>
  <span class="token comment">// 返回 _.pick 的补集</span>
  <span class="token comment">// 即返回没有指定 keys 值的对象副本</span>
  <span class="token comment">// 或者返回不能通过 predicate 函数的对象副本</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">omit</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// _.negate 方法对 iteratee 的结果取反</span>
      iteratee <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">negate</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token function">flatten</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> String<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function-variable function">iteratee</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>keys<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">pick</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// _.defaults(object, *defaults)</span>
  <span class="token comment">// Fill in a given object with default properties.</span>
  <span class="token comment">// Fill in undefined properties in object</span>
  <span class="token comment">// with the first value present in the following list of defaults objects.</span>
  <span class="token comment">// 和 _.extend 非常类似</span>
  <span class="token comment">// 区别是如果 *defaults 中出现了和 object 中一样的键</span>
  <span class="token comment">// 则不覆盖 object 的键值对</span>
  <span class="token comment">// 如果 *defaults 多个参数对象中有相同 key 的对象</span>
  <span class="token comment">// 则取最早出现的 value 值</span>
  <span class="token comment">// 参数个数 &gt;= 1</span>
  _<span class="token punctuation">.</span>defaults <span class="token operator">=</span> <span class="token function">createAssigner</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span>allKeys<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Creates an object that inherits from the given prototype object.</span>
  <span class="token comment">// If additional properties are provided then they will be added to the</span>
  <span class="token comment">// created object.</span>
  <span class="token comment">// 给定 prototype</span>
  <span class="token comment">// 以及一些 own properties</span>
  <span class="token comment">// 构造一个新的对象并返回</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prototype<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">baseCreate</span><span class="token punctuation">(</span>prototype<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将 props 的键值对覆盖 result 对象</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">)</span> _<span class="token punctuation">.</span><span class="token function">extendOwn</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> props<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Create a (shallow-cloned) duplicate of an object.</span>
  <span class="token comment">// 对象的 `浅复制` 副本</span>
  <span class="token comment">// 注意点：所有嵌套的对象或者数组都会跟原对象用同一个引用</span>
  <span class="token comment">// 所以是为浅复制，而不是深度克隆</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">clone</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 容错，如果不是对象或者数组类型，则可以直接返回</span>
    <span class="token comment">// 因为一些基础类型是直接按值传递的</span>
    <span class="token comment">// 思考，arguments 呢？ Nodelists 呢？ HTML Collections 呢？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isObject</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> obj<span class="token punctuation">;</span>

    <span class="token comment">// 如果是数组，则用 obj.slice() 返回数组副本</span>
    <span class="token comment">// 如果是对象，则提取所有 obj 的键值对覆盖空对象，返回</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">?</span> obj<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Invokes interceptor with the obj, and then returns obj.</span>
  <span class="token comment">// The primary purpose of this method is to &quot;tap into&quot; a method chain, in</span>
  <span class="token comment">// order to perform operations on intermediate results within the chain.</span>
  <span class="token comment">// _.chain([1,2,3,200])</span>
  <span class="token comment">// .filter(function(num) { return num % 2 == 0; })</span>
  <span class="token comment">// .tap(alert)</span>
  <span class="token comment">// .map(function(num) { return num * num })</span>
  <span class="token comment">// .value();</span>
  <span class="token comment">// =&gt; // [2, 200] (alerted)</span>
  <span class="token comment">// =&gt; [4, 40000]</span>
  <span class="token comment">// 主要是用在链式调用中</span>
  <span class="token comment">// 对中间值立即进行处理</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">tap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> interceptor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">interceptor</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns whether an object has a given set of `key:value` pairs.</span>
  <span class="token comment">// attrs 参数为一个对象</span>
  <span class="token comment">// 判断 object 对象中是否有 attrs 中的所有 key-value 键值对</span>
  <span class="token comment">// 返回布尔值</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isMatch</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 提取 attrs 对象的所有 keys</span>
    <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>attrs<span class="token punctuation">)</span><span class="token punctuation">,</span>
      length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token comment">// 如果 object 为空</span>
    <span class="token comment">// 根据 attrs 的键值对数量返回布尔值</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">!</span>length<span class="token punctuation">;</span>

    <span class="token comment">// 这一步有必要？</span>
    <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token function">Object</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 遍历 attrs 对象键值对</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> key <span class="token operator">=</span> keys<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token comment">// 如果 obj 对象没有 attrs 对象的某个 key</span>
      <span class="token comment">// 或者对于某个 key，它们的 value 值不同</span>
      <span class="token comment">// 则证明 object 并不拥有 attrs 的所有键值对</span>
      <span class="token comment">// 则返回 false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> obj<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Internal recursive comparison function for `isEqual`.</span>
  <span class="token comment">// &quot;内部的&quot;/ &quot;递归地&quot;/ &quot;比较&quot;</span>
  <span class="token comment">// 该内部方法会被递归调用</span>
  <span class="token keyword">var</span> <span class="token function-variable function">eq</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> aStack<span class="token punctuation">,</span> bStack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Identical objects are equal. `0 === -0`, but they aren't identical.</span>
    <span class="token comment">// See the [Harmony `egal` proposal](http://wiki.ecmascript.org/doku.php?id=harmony:egal).</span>
    <span class="token comment">// a === b 时</span>
    <span class="token comment">// 需要注意 `0 === -0` 这个 special case</span>
    <span class="token comment">// 0 和 -0 被认为不相同（unequal）</span>
    <span class="token comment">// 至于原因可以参考上面的链接</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">===</span> b<span class="token punctuation">)</span> <span class="token keyword">return</span> a <span class="token operator">!==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token number">1</span> <span class="token operator">/</span> a <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">/</span> b<span class="token punctuation">;</span>

    <span class="token comment">// A strict comparison is necessary because `null == undefined`.</span>
    <span class="token comment">// 如果 a 和 b 有一个为 null（或者 undefined）</span>
    <span class="token comment">// 判断 a === b</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> b <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> a <span class="token operator">===</span> b<span class="token punctuation">;</span>

    <span class="token comment">// Unwrap any wrapped objects.</span>
    <span class="token comment">// 如果 a 和 b 是 underscore OOP 的对象</span>
    <span class="token comment">// 那么比较 _wrapped 属性值（Unwrap）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span> a <span class="token operator">=</span> a<span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token keyword">instanceof</span> <span class="token class-name">_</span><span class="token punctuation">)</span> b <span class="token operator">=</span> b<span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>

    <span class="token comment">// Compare `[[Class]]` names.</span>
    <span class="token comment">// 用 Object.prototype.toString.call 方法获取 a 变量类型</span>
    <span class="token keyword">var</span> className <span class="token operator">=</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 a 和 b 类型不相同，则返回 false</span>
    <span class="token comment">// 类型都不同了还比较个蛋！</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">!==</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Strings, numbers, regular expressions, dates, and booleans are compared by value.</span>
      <span class="token comment">// 以上五种类型的元素可以直接根据其 value 值来比较是否相等</span>
      <span class="token keyword">case</span> <span class="token string">'[object RegExp]'</span><span class="token punctuation">:</span>
      <span class="token comment">// RegExps are coerced to strings for comparison (Note: '' + /a/i === '/a/i')</span>
      <span class="token keyword">case</span> <span class="token string">'[object String]'</span><span class="token punctuation">:</span>
        <span class="token comment">// Primitives and their corresponding object wrappers are equivalent; thus, `&quot;5&quot;` is</span>
        <span class="token comment">// equivalent to `new String(&quot;5&quot;)`.</span>
        <span class="token comment">// 转为 String 类型进行比较</span>
        <span class="token keyword">return</span> <span class="token string">''</span> <span class="token operator">+</span> a <span class="token operator">===</span> <span class="token string">''</span> <span class="token operator">+</span> b<span class="token punctuation">;</span>

      <span class="token comment">// RegExp 和 String 可以看做一类</span>
      <span class="token comment">// 如果 obj 为 RegExp 或者 String 类型</span>
      <span class="token comment">// 那么 '' + obj 会将 obj 强制转为 String</span>
      <span class="token comment">// 根据 '' + a === '' + b 即可判断 a 和 b 是否相等</span>
      <span class="token comment">// ================</span>

      <span class="token keyword">case</span> <span class="token string">'[object Number]'</span><span class="token punctuation">:</span>
        <span class="token comment">// `NaN`s are equivalent, but non-reflexive.</span>
        <span class="token comment">// Object(NaN) is equivalent to NaN</span>
        <span class="token comment">// 如果 +a !== +a</span>
        <span class="token comment">// 那么 a 就是 NaN</span>
        <span class="token comment">// 判断 b 是否也是 NaN 即可</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">+</span>a <span class="token operator">!==</span> <span class="token operator">+</span>a<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token operator">+</span>b <span class="token operator">!==</span> <span class="token operator">+</span>b<span class="token punctuation">;</span>

        <span class="token comment">// An `egal` comparison is performed for other numeric values.</span>
        <span class="token comment">// 排除了 NaN 干扰</span>
        <span class="token comment">// 还要考虑 0 的干扰</span>
        <span class="token comment">// 用 +a 将 Number() 形式转为基本类型</span>
        <span class="token comment">// 即 +Number(1) ==&gt; 1</span>
        <span class="token comment">// 0 需要特判</span>
        <span class="token comment">// 如果 a 为 0，判断 1 / +a === 1 / b</span>
        <span class="token comment">// 否则判断 +a === +b</span>
        <span class="token keyword">return</span> <span class="token operator">+</span>a <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token operator">+</span>a <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">/</span> b <span class="token punctuation">:</span> <span class="token operator">+</span>a <span class="token operator">===</span> <span class="token operator">+</span>b<span class="token punctuation">;</span>

      <span class="token comment">// 如果 a 为 Number 类型</span>
      <span class="token comment">// 要注意 NaN 这个 special number</span>
      <span class="token comment">// NaN 和 NaN 被认为 equal</span>
      <span class="token comment">// ================</span>

      <span class="token keyword">case</span> <span class="token string">'[object Date]'</span><span class="token punctuation">:</span>
      <span class="token keyword">case</span> <span class="token string">'[object Boolean]'</span><span class="token punctuation">:</span>
        <span class="token comment">// Coerce dates and booleans to numeric primitive values. Dates are compared by their</span>
        <span class="token comment">// millisecond representations. Note that invalid dates with millisecond representations</span>
        <span class="token comment">// of `NaN` are not equivalent.</span>
        <span class="token keyword">return</span> <span class="token operator">+</span>a <span class="token operator">===</span> <span class="token operator">+</span>b<span class="token punctuation">;</span>

      <span class="token comment">// Date 和 Boolean 可以看做一类</span>
      <span class="token comment">// 如果 obj 为 Date 或者 Boolean</span>
      <span class="token comment">// 那么 +obj 会将 obj 转为 Number 类型</span>
      <span class="token comment">// 然后比较即可</span>
      <span class="token comment">// +new Date() 是当前时间距离 1970 年 1 月 1 日 0 点的毫秒数</span>
      <span class="token comment">// +true =&gt; 1</span>
      <span class="token comment">// +new Boolean(false) =&gt; 0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 判断 a 是否是数组</span>
    <span class="token keyword">var</span> areArrays <span class="token operator">=</span> className <span class="token operator">===</span> <span class="token string">'[object Array]'</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果 a 不是数组类型</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>areArrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 a 不是 object 或者 b 不是 object</span>
      <span class="token comment">// 则返回 false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> a <span class="token operator">!=</span> <span class="token string">'object'</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> b <span class="token operator">!=</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token comment">// 通过上个步骤的 if 过滤</span>
      <span class="token comment">// !!保证到此的 a 和 b 均为对象!!</span>

      <span class="token comment">// Objects with different constructors are not equivalent, but `Object`s or `Array`s</span>
      <span class="token comment">// from different frames are.</span>
      <span class="token comment">// 通过构造函数来判断 a 和 b 是否相同</span>
      <span class="token comment">// 但是，如果 a 和 b 的构造函数不同</span>
      <span class="token comment">// 也并不一定 a 和 b 就是 unequal</span>
      <span class="token comment">// 比如 a 和 b 在不同的 iframes 中！</span>
      <span class="token comment">// aCtor instanceof aCtor 这步有点不大理解，啥用？</span>
      <span class="token keyword">var</span> aCtor <span class="token operator">=</span> a<span class="token punctuation">.</span>constructor<span class="token punctuation">,</span>
        bCtor <span class="token operator">=</span> b<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        aCtor <span class="token operator">!==</span> bCtor <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span><span class="token punctuation">(</span>
          _<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>aCtor<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          aCtor <span class="token keyword">instanceof</span> <span class="token class-name">aCtor</span> <span class="token operator">&amp;&amp;</span>
          _<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>bCtor<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          bCtor <span class="token keyword">instanceof</span> <span class="token class-name">bCtor</span>
        <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span><span class="token string">'constructor'</span> <span class="token keyword">in</span> a <span class="token operator">&amp;&amp;</span> <span class="token string">'constructor'</span> <span class="token keyword">in</span> b<span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Assume equality for cyclic structures. The algorithm for detecting cyclic</span>
    <span class="token comment">// structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.</span>

    <span class="token comment">// Initializing stack of traversed objects.</span>
    <span class="token comment">// It's done here since we only need them for objects and arrays comparison.</span>
    <span class="token comment">// 第一次调用 eq() 函数，没有传入 aStack 和 bStack 参数</span>
    <span class="token comment">// 之后递归调用都会传入这两个参数</span>
    aStack <span class="token operator">=</span> aStack <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    bStack <span class="token operator">=</span> bStack <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">var</span> length <span class="token operator">=</span> aStack<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>length<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Linear search. Performance is inversely proportional to the number of</span>
      <span class="token comment">// unique nested structures.</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aStack<span class="token punctuation">[</span>length<span class="token punctuation">]</span> <span class="token operator">===</span> a<span class="token punctuation">)</span> <span class="token keyword">return</span> bStack<span class="token punctuation">[</span>length<span class="token punctuation">]</span> <span class="token operator">===</span> b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Add the first object to the stack of traversed objects.</span>
    aStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Recursively compare objects and arrays.</span>
    <span class="token comment">// 将嵌套的对象和数组展开</span>
    <span class="token comment">// 如果 a 是数组</span>
    <span class="token comment">// 因为嵌套，所以需要展开深度比较</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>areArrays<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Compare array lengths to determine if a deep comparison is necessary.</span>
      <span class="token comment">// 根据 length 判断是否应该继续递归对比</span>
      length <span class="token operator">=</span> a<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token comment">// 如果 a 和 b length 属性大小不同</span>
      <span class="token comment">// 那么显然 a 和 b 不同</span>
      <span class="token comment">// return false 不用继续比较了</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">!==</span> b<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token comment">// Deep compare the contents, ignoring non-numeric properties.</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>length<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 递归</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">eq</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">,</span> aStack<span class="token punctuation">,</span> bStack<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 a 不是数组</span>
      <span class="token comment">// 进入这个判断分支</span>

      <span class="token comment">// Deep compare objects.</span>
      <span class="token comment">// 两个对象的深度比较</span>
      <span class="token keyword">var</span> keys <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span>
        key<span class="token punctuation">;</span>
      length <span class="token operator">=</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token comment">// Ensure that both objects contain the same number of properties before comparing deep equality.</span>
      <span class="token comment">// a 和 b 对象的键数量不同</span>
      <span class="token comment">// 那还比较毛？</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">!==</span> length<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>length<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Deep compare each member</span>
        <span class="token comment">// 递归比较</span>
        key <span class="token operator">=</span> keys<span class="token punctuation">[</span>length<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">eq</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> aStack<span class="token punctuation">,</span> bStack<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Remove the first object from the stack of traversed objects.</span>
    <span class="token comment">// 与 aStack.push(a) 对应</span>
    <span class="token comment">// 此时 aStack 栈顶元素正是 a</span>
    <span class="token comment">// 而代码走到此步</span>
    <span class="token comment">// a 和 b isEqual 确认</span>
    <span class="token comment">// 所以 a，b 两个元素可以出栈</span>
    aStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    bStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 深度搜索递归比较完毕</span>
    <span class="token comment">// 放心地 return true</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Perform a deep comparison to check if two objects are equal.</span>
  <span class="token comment">// 判断两个对象是否一样</span>
  <span class="token comment">// new Boolean(true)，true 被认为 equal</span>
  <span class="token comment">// [1, 2, 3], [1, 2, 3] 被认为 equal</span>
  <span class="token comment">// 0 和 -0 被认为 unequal</span>
  <span class="token comment">// NaN 和 NaN 被认为 equal</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isEqual</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">eq</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given array, string, or object empty?</span>
  <span class="token comment">// An &quot;empty&quot; object has no enumerable own-properties.</span>
  <span class="token comment">// 是否是 {}、[] 或者 &quot;&quot; 或者 null、undefined</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isEmpty</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是数组、类数组、或者字符串</span>
    <span class="token comment">// 根据 length 属性判断是否为空</span>
    <span class="token comment">// 后面的条件是为了过滤 isArrayLike 对于 {length: 10} 这样对象的判断 bug？</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token function">isArrayLike</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">||</span> _<span class="token punctuation">.</span><span class="token function">isString</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">||</span> _<span class="token punctuation">.</span><span class="token function">isArguments</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
      <span class="token keyword">return</span> obj<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 如果是对象</span>
    <span class="token comment">// 根据 keys 数量判断是否为 Empty</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given value a DOM element?</span>
  <span class="token comment">// 判断是否为 DOM 元素</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isElement</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 确保 obj 不是 null, undefined 等假值</span>
    <span class="token comment">// 并且 obj.nodeType === 1</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">(</span>obj <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>nodeType <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given value an array?</span>
  <span class="token comment">// Delegates to ECMA5's native Array.isArray</span>
  <span class="token comment">// 判断是否为数组</span>
  _<span class="token punctuation">.</span>isArray <span class="token operator">=</span>
    nativeIsArray <span class="token operator">||</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Array]'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given variable an object?</span>
  <span class="token comment">// 判断是否为对象</span>
  <span class="token comment">// 这里的对象包括 function 和 object</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isObject</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> obj<span class="token punctuation">;</span>
    <span class="token keyword">return</span> type <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token operator">!</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Add some isType methods: isArguments, isFunction, isString, isNumber, isDate, isRegExp, isError.</span>
  <span class="token comment">// 其他类型判断</span>
  _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'Arguments'</span><span class="token punctuation">,</span> <span class="token string">'Function'</span><span class="token punctuation">,</span> <span class="token string">'String'</span><span class="token punctuation">,</span> <span class="token string">'Number'</span><span class="token punctuation">,</span> <span class="token string">'Date'</span><span class="token punctuation">,</span> <span class="token string">'RegExp'</span><span class="token punctuation">,</span> <span class="token string">'Error'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _<span class="token punctuation">[</span><span class="token string">'is'</span> <span class="token operator">+</span> name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object '</span> <span class="token operator">+</span> name <span class="token operator">+</span> <span class="token string">']'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Define a fallback version of the method in browsers (ahem, IE &lt; 9), where</span>
  <span class="token comment">// there isn't any inspectable &quot;Arguments&quot; type.</span>
  <span class="token comment">// _.isArguments 方法在 IE &lt; 9 下的兼容</span>
  <span class="token comment">// IE &lt; 9 下对 arguments 调用 Object.prototype.toString.call 方法</span>
  <span class="token comment">// 结果是 =&gt; [object Object]</span>
  <span class="token comment">// 而并非我们期望的 [object Arguments]。</span>
  <span class="token comment">// so 用是否含有 callee 属性来做兼容</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_<span class="token punctuation">.</span><span class="token function">isArguments</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span><span class="token function-variable function">isArguments</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token string">'callee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Optimize `isFunction` if appropriate. Work around some typeof bugs in old v8,</span>
  <span class="token comment">// IE 11 (#1621), and in Safari 8 (#1929).</span>
  <span class="token comment">// _.isFunction 在 old v8, IE 11 和 Safari 8 下的兼容</span>
  <span class="token comment">// 觉得这里有点问题</span>
  <span class="token comment">// 我用的 chrome 49 (显然不是 old v8)</span>
  <span class="token comment">// 却也进入了这个 if 判断内部</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">/</span> <span class="token operator">!=</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> Int8Array <span class="token operator">!=</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _<span class="token punctuation">.</span><span class="token function-variable function">isFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">==</span> <span class="token string">'function'</span> <span class="token operator">||</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// Is a given object a finite number?</span>
  <span class="token comment">// 判断是否是有限的数字</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isFinite</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">isFinite</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span><span class="token function">parseFloat</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is the given value `NaN`? (NaN is the only number which does not equal itself).</span>
  <span class="token comment">// 判断是否是 NaN</span>
  <span class="token comment">// NaN 是唯一的一个 `自己不等于自己` 的 number 类型</span>
  <span class="token comment">// 这样写有 BUG</span>
  <span class="token comment">// _.isNaN(new Number(0)) =&gt; true</span>
  <span class="token comment">// 详见 https://github.com/hanzichi/underscore-analysis/issues/13</span>
  <span class="token comment">// 最新版本（edge 版）已经修复该 BUG</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isNaN</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">isNumber</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!==</span> <span class="token operator">+</span>obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given value a boolean?</span>
  <span class="token comment">// 判断是否是布尔值</span>
  <span class="token comment">// 基础类型（true、 false）</span>
  <span class="token comment">// 以及 new Boolean() 两个方向判断</span>
  <span class="token comment">// 有点多余了吧？</span>
  <span class="token comment">// 个人觉得直接用 toString.call(obj) 来判断就可以了</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isBoolean</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      obj <span class="token operator">===</span> <span class="token boolean">true</span> <span class="token operator">||</span> obj <span class="token operator">===</span> <span class="token boolean">false</span> <span class="token operator">||</span> <span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Boolean]'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given value equal to null?</span>
  <span class="token comment">// 判断是否是 null</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isNull</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Is a given variable undefined?</span>
  <span class="token comment">// 判断是否是 undefined</span>
  <span class="token comment">// undefined 能被改写 （IE &lt; 9）</span>
  <span class="token comment">// undefined 只是全局对象的一个属性</span>
  <span class="token comment">// 在局部环境能被重新定义</span>
  <span class="token comment">// 但是「void 0」始终是 undefined</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">isUndefined</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Shortcut function for checking if an object has a given property directly</span>
  <span class="token comment">// on itself (in other words, not on a prototype).</span>
  <span class="token comment">// 判断对象中是否有指定 key</span>
  <span class="token comment">// own properties, not on a prototype</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">has</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// obj 不能为 null 或者 undefined</span>
    <span class="token keyword">return</span> obj <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Utility Functions</span>
  <span class="token comment">// 工具类方法</span>
  <span class="token comment">// 共 14 个扩展方法</span>
  <span class="token comment">// -----------------</span>

  <span class="token comment">// Run Underscore.js in *noConflict* mode, returning the `_` variable to its</span>
  <span class="token comment">// previous owner. Returns a reference to the Underscore object.</span>
  <span class="token comment">// 如果全局环境中已经使用了 `_` 变量</span>
  <span class="token comment">// 可以用该方法返回其他变量</span>
  <span class="token comment">// 继续使用 underscore 中的方法</span>
  <span class="token comment">// var underscore = _.noConflict();</span>
  <span class="token comment">// underscore.each(..);</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">noConflict</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root<span class="token punctuation">.</span>_ <span class="token operator">=</span> previousUnderscore<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Keep the identity function around for default iteratees.</span>
  <span class="token comment">// 返回传入的参数，看起来好像没什么卵用</span>
  <span class="token comment">// 其实 _.identity 在 undescore 内大量作为迭代函数出现</span>
  <span class="token comment">// 能简化很多迭代函数的书写</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">identity</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Predicate-generating functions. Often useful outside of Underscore.</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">constant</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  _<span class="token punctuation">.</span><span class="token function-variable function">noop</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 传送门</span>
  <span class="token comment">/*
  var property = function(key) {
    return function(obj) {
      return obj == null ? void 0 : obj[key];
    };
  };
  */</span>
  _<span class="token punctuation">.</span>property <span class="token operator">=</span> property<span class="token punctuation">;</span>

  <span class="token comment">// Generates a function for a given object that returns a given property.</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">propertyOf</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> obj <span class="token operator">==</span> <span class="token keyword">null</span>
      <span class="token operator">?</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Returns a predicate for checking whether an object has a given set of</span>
  <span class="token comment">// `key:value` pairs.</span>
  <span class="token comment">// 判断一个给定的对象是否有某些键值对</span>
  _<span class="token punctuation">.</span>matcher <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function-variable function">matches</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">attrs</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attrs <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">extendOwn</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Run a function **n** times.</span>
  <span class="token comment">// 执行某函数 n 次</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">times</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">n<span class="token punctuation">,</span> iteratee<span class="token punctuation">,</span> context</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> accum <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    iteratee <span class="token operator">=</span> <span class="token function">optimizeCb</span><span class="token punctuation">(</span>iteratee<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> accum<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">iteratee</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> accum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Return a random integer between min and max (inclusive).</span>
  <span class="token comment">// 返回一个 [min, max] 范围内的任意整数</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">random</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">min<span class="token punctuation">,</span> max</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>max <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      max <span class="token operator">=</span> min<span class="token punctuation">;</span>
      min <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> min <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max <span class="token operator">-</span> min <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// A (possibly faster) way to get the current timestamp as an integer.</span>
  <span class="token comment">// 返回当前时间的 &quot;时间戳&quot;（单位 ms）</span>
  <span class="token comment">// 其实并不是时间戳，时间戳还要除以 1000（单位 s）</span>
  <span class="token comment">// +new Date 类似</span>
  _<span class="token punctuation">.</span>now <span class="token operator">=</span>
    Date<span class="token punctuation">.</span>now <span class="token operator">||</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// List of HTML entities for escaping.</span>
  <span class="token comment">// HTML 实体编码</span>
  <span class="token comment">// escapeMap 用于编码</span>
  <span class="token comment">// see @http://www.cnblogs.com/zichi/p/5135636.html</span>
  <span class="token comment">// in PHP, htmlspecialchars — Convert special characters to HTML entities</span>
  <span class="token comment">// see @http://php.net/manual/zh/function.htmlspecialchars.php</span>
  <span class="token comment">// 能将 &amp; &quot; ' &lt; &gt; 转为实体编码（下面的前 5 种）</span>
  <span class="token keyword">var</span> escapeMap <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'&amp;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;amp;'</span><span class="token punctuation">,</span>
    <span class="token string">'&lt;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">,</span>
    <span class="token string">'&gt;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">,</span>
    <span class="token string">'&quot;'</span><span class="token punctuation">:</span> <span class="token string">'&amp;quot;'</span><span class="token punctuation">,</span>
    <span class="token comment">// 以上四个为最常用的字符实体</span>
    <span class="token comment">// 也是仅有的可以在所有环境下使用的实体字符（其他应该用「实体数字」，如下）</span>
    <span class="token comment">// 浏览器也许并不支持所有实体名称（对实体数字的支持却很好）</span>
    <span class="token string">&quot;'&quot;</span><span class="token punctuation">:</span> <span class="token string">'&amp;#x27;'</span><span class="token punctuation">,</span>
    <span class="token string">'`'</span><span class="token punctuation">:</span> <span class="token string">'&amp;#x60;'</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// _.invert 方法将一个对象的键值对对调</span>
  <span class="token operator">/</span><span class="token operator">/</span> unescapeMap 用于解码
  <span class="token keyword">var</span> unescapeMap <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">invert</span><span class="token punctuation">(</span>escapeMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> Functions <span class="token keyword">for</span> escaping and unescaping strings to<span class="token operator">/</span><span class="token keyword">from</span> <span class="token constant">HTML</span> interpolation<span class="token punctuation">.</span>
  <span class="token keyword">var</span> <span class="token function-variable function">createEscaper</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">escaper</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> map<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">/</span> Regexes <span class="token keyword">for</span> identifying a key that needs to be escaped
    <span class="token operator">/</span><span class="token operator">/</span> 正则替换
    <span class="token operator">/</span><span class="token operator">/</span> 注意下 <span class="token operator">?</span><span class="token punctuation">:</span>
    <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">'(?:'</span> <span class="token operator">+</span> _<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">/</span> 正则 pattern
    <span class="token keyword">var</span> testRegexp <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">/</span> 全局替换
    <span class="token keyword">var</span> replaceRegexp <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token string">'g'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      string <span class="token operator">=</span> string <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token punctuation">:</span> <span class="token string">''</span> <span class="token operator">+</span> string<span class="token punctuation">;</span>
      <span class="token keyword">return</span> testRegexp<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>string<span class="token punctuation">)</span>
        <span class="token operator">?</span> string<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>replaceRegexp<span class="token punctuation">,</span> escaper<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> string<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> Escapes a string <span class="token keyword">for</span> insertion into <span class="token constant">HTML</span><span class="token punctuation">,</span> replacing <span class="token operator">&amp;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token punctuation">,</span> <span class="token operator">&gt;</span><span class="token punctuation">,</span> &quot;<span class="token punctuation">,</span> <span class="token template-string"><span class="token string">`, and ' characters.
  // 编码，防止被 XSS 攻击等一些安全隐患
  _.escape = createEscaper(escapeMap);

  // The opposite of escape
  // replaces &amp;amp;, &amp;lt;, &amp;gt;, &amp;quot;, &amp;#96; and &amp;#x27; with their unescaped counterparts
  // 解码
  _.unescape = createEscaper(unescapeMap);

  // If the value of the named `</span></span>property` is a <span class="token keyword">function</span> then invoke it <span class="token keyword">with</span> the
  <span class="token comment">// `object` as context; otherwise, return it.</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">result</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">object<span class="token punctuation">,</span> property<span class="token punctuation">,</span> fallback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> value <span class="token operator">=</span> object <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">void</span> <span class="token number">0</span> <span class="token punctuation">:</span> object<span class="token punctuation">[</span>property<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      value <span class="token operator">=</span> fallback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> _<span class="token punctuation">.</span><span class="token function">isFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span> <span class="token punctuation">:</span> value<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Generate a unique integer id (unique within the entire client session).</span>
  <span class="token comment">// Useful for temporary DOM ids.</span>
  <span class="token comment">// 生成客户端临时的 DOM ids</span>
  <span class="token keyword">var</span> idCounter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">uniqueId</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">prefix</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> <span class="token operator">++</span>idCounter <span class="token operator">+</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> prefix <span class="token operator">?</span> prefix <span class="token operator">+</span> id <span class="token punctuation">:</span> id<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// By default, Underscore uses ERB-style template delimiters, change the</span>
  <span class="token comment">// following template settings to use alternative delimiters.</span>
  <span class="token comment">// ERB =&gt; Embedded Ruby</span>
  <span class="token comment">// Underscore 默认采用 ERB-style 风格模板，也可以根据自己习惯自定义模板</span>
  <span class="token comment">// 1. &lt;%  %&gt; - to execute some code</span>
  <span class="token comment">// 2. &lt;%= %&gt; - to print some value in template</span>
  <span class="token comment">// 3. &lt;%- %&gt; - to print some values HTML escaped</span>
  _<span class="token punctuation">.</span>templateSettings <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token comment">// 三种渲染模板</span>
    evaluate<span class="token punctuation">:</span> <span class="token regex">/&lt;%([\s\S]+?)%&gt;/g</span><span class="token punctuation">,</span>
    interpolate<span class="token punctuation">:</span> <span class="token regex">/&lt;%=([\s\S]+?)%&gt;/g</span><span class="token punctuation">,</span>
    escape<span class="token punctuation">:</span> <span class="token regex">/&lt;%-([\s\S]+?)%&gt;/g</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// When customizing `templateSettings`, if you don't want to define an</span>
  <span class="token comment">// interpolation, evaluation or escaping regex, we need one that is</span>
  <span class="token comment">// guaranteed not to match.</span>
  <span class="token keyword">var</span> noMatch <span class="token operator">=</span> <span class="token regex">/(.)^/</span><span class="token punctuation">;</span>

  <span class="token comment">// Certain characters need to be escaped so that they can be put into a</span>
  <span class="token comment">// string literal.</span>
  <span class="token keyword">var</span> escapes <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;'&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;'&quot;</span><span class="token punctuation">,</span>
    <span class="token string">'\\'</span><span class="token punctuation">:</span> <span class="token string">'\\'</span><span class="token punctuation">,</span>
    <span class="token string">'\r'</span><span class="token punctuation">:</span> <span class="token string">'r'</span><span class="token punctuation">,</span> <span class="token comment">// 回车符</span>
    <span class="token string">'\n'</span><span class="token punctuation">:</span> <span class="token string">'n'</span><span class="token punctuation">,</span> <span class="token comment">// 换行符</span>
    <span class="token comment">// http://stackoverflow.com/questions/16686687/json-stringify-and-u2028-u2029-check</span>
    <span class="token string">'\u2028'</span><span class="token punctuation">:</span> <span class="token string">'u2028'</span><span class="token punctuation">,</span> <span class="token comment">// Line separator</span>
    <span class="token string">'\u2029'</span><span class="token punctuation">:</span> <span class="token string">'u2029'</span> <span class="token comment">// Paragraph separator</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// RegExp pattern</span>
  <span class="token keyword">var</span> escaper <span class="token operator">=</span> <span class="token regex">/\\|'|\r|\n|\u2028|\u2029/g</span><span class="token punctuation">;</span>

  <span class="token keyword">var</span> <span class="token function-variable function">escapeChar</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">match</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
      '      =&gt; \\'
      \\     =&gt; \\\\
      \r     =&gt; \\r
      \n     =&gt; \\n
      \u2028 =&gt; \\u2028
      \u2029 =&gt; \\u2029
    **/</span>
    <span class="token keyword">return</span> <span class="token string">'\\'</span> <span class="token operator">+</span> escapes<span class="token punctuation">[</span>match<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// 将 JavaScript 模板编译为可以用于页面呈现的函数</span>
  <span class="token comment">// JavaScript micro-templating, similar to John Resig's implementation.</span>
  <span class="token comment">// Underscore templating handles arbitrary delimiters, preserves whitespace,</span>
  <span class="token comment">// and correctly escapes quotes within interpolated code.</span>
  <span class="token comment">// NB: `oldSettings` only exists for backwards compatibility.</span>
  <span class="token comment">// oldSettings 参数为了兼容 underscore 旧版本</span>
  <span class="token comment">// setting 参数可以用来自定义字符串模板（但是 key 要和 _.templateSettings 中的相同，才能 overridden）</span>
  <span class="token comment">// 1. &lt;%  %&gt; - to execute some code</span>
  <span class="token comment">// 2. &lt;%= %&gt; - to print some value in template</span>
  <span class="token comment">// 3. &lt;%- %&gt; - to print some values HTML escaped</span>
  <span class="token comment">// Compiles JavaScript templates into functions</span>
  <span class="token comment">// _.template(templateString, [settings])</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">text<span class="token punctuation">,</span> settings<span class="token punctuation">,</span> oldSettings</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 兼容旧版本</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings <span class="token operator">&amp;&amp;</span> oldSettings<span class="token punctuation">)</span> settings <span class="token operator">=</span> oldSettings<span class="token punctuation">;</span>

    <span class="token comment">// 相同的 key，优先选择 settings 对象中的</span>
    <span class="token comment">// 其次选择 _.templateSettings 对象中的</span>
    <span class="token comment">// 生成最终用来做模板渲染的字符串</span>
    <span class="token comment">// 自定义模板优先于默认模板 _.templateSettings</span>
    <span class="token comment">// 如果定义了相同的 key，则前者会覆盖后者</span>
    settings <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">defaults</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> settings<span class="token punctuation">,</span> _<span class="token punctuation">.</span>templateSettings<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Combine delimiters into one regular expression via alternation.</span>
    <span class="token comment">// 正则表达式 pattern，用于正则匹配 text 字符串中的模板字符串</span>
    <span class="token comment">// /&lt;%-([\s\S]+?)%&gt;|&lt;%=([\s\S]+?)%&gt;|&lt;%([\s\S]+?)%&gt;|$/g</span>
    <span class="token comment">// 注意最后还有个 |$</span>
    <span class="token keyword">var</span> matcher <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>
        <span class="token comment">// 注意下 pattern 的 source 属性</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>escape <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>interpolate <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source<span class="token punctuation">,</span>
        <span class="token punctuation">(</span>settings<span class="token punctuation">.</span>evaluate <span class="token operator">||</span> noMatch<span class="token punctuation">)</span><span class="token punctuation">.</span>source
      <span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">'|'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'|$'</span><span class="token punctuation">,</span>
      <span class="token string">'g'</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Compile the template source, escaping string literals appropriately.</span>
    <span class="token comment">// 编译模板字符串，将原始的模板字符串替换成函数字符串</span>
    <span class="token comment">// 用拼接成的函数字符串生成函数（new Function(...)）</span>
    <span class="token keyword">var</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// source 变量拼接的字符串用来生成函数</span>
    <span class="token comment">// 用于当做 new Function 生成函数时的函数字符串变量</span>
    <span class="token comment">// 记录编译成的函数字符串，可通过 _.template(tpl).source 获取（_.template(tpl) 返回方法）</span>
    <span class="token keyword">var</span> source <span class="token operator">=</span> <span class="token string">&quot;__p+='&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// replace 函数不需要为返回值赋值，主要是为了在函数内对 source 变量赋值</span>
    <span class="token comment">// 将 text 变量中的模板提取出来</span>
    <span class="token comment">// match 为匹配的整个串</span>
    <span class="token comment">// escape/interpolate/evaluate 为匹配的子表达式（如果没有匹配成功则为 undefined）</span>
    <span class="token comment">// offset 为字符匹配（match）的起始位置（偏移量）</span>
    text<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>matcher<span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>
      <span class="token parameter">match<span class="token punctuation">,</span>
      escape<span class="token punctuation">,</span>
      interpolate<span class="token punctuation">,</span>
      evaluate<span class="token punctuation">,</span>
      offset</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// \n =&gt; \\n</span>
      source <span class="token operator">+=</span> text<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>escaper<span class="token punctuation">,</span> escapeChar<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 改变 index 值，为了下次的 slice</span>
      index <span class="token operator">=</span> offset <span class="token operator">+</span> match<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>escape<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 需要对变量进行编码（=&gt; HTML 实体编码）</span>
        <span class="token comment">// 避免 XSS 攻击</span>
        source <span class="token operator">+=</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> escape <span class="token operator">+</span> <span class="token string">&quot;))==null?'':_.escape(__t))+\n'&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>interpolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 单纯的插入变量</span>
        source <span class="token operator">+=</span> <span class="token string">&quot;'+\n((__t=(&quot;</span> <span class="token operator">+</span> interpolate <span class="token operator">+</span> <span class="token string">&quot;))==null?'':__t)+\n'&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>evaluate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 可以直接执行的 JavaScript 语句</span>
        <span class="token comment">// 注意 &quot;__p+=&quot;，__p 为渲染返回的字符串</span>
        source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span> <span class="token operator">+</span> evaluate <span class="token operator">+</span> <span class="token string">&quot;\n__p+='&quot;</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// Adobe VMs need the match returned to produce the correct offset.</span>
      <span class="token comment">// return 的作用是？</span>
      <span class="token comment">// 将匹配到的内容原样返回（Adobe VMs 需要返回 match 来使得 offset 值正常）</span>
      <span class="token keyword">return</span> match<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    source <span class="token operator">+=</span> <span class="token string">&quot;';\n&quot;</span><span class="token punctuation">;</span>

    <span class="token comment">// By default, `template` places the values from your data in the local scope via the `with` statement.</span>
    <span class="token comment">// However, you can specify a single variable name with the variable setting.</span>
    <span class="token comment">// This can significantly improve the speed at which a template is able to render.</span>
    <span class="token comment">// If a variable is not specified, place data values in local scope.</span>
    <span class="token comment">// 指定 scope</span>
    <span class="token comment">// 如果设置了 settings.variable，能显著提升模板的渲染速度</span>
    <span class="token comment">// 否则，默认用 with 语句指定作用域</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>settings<span class="token punctuation">.</span>variable<span class="token punctuation">)</span> source <span class="token operator">=</span> <span class="token string">'with(obj||{}){\n'</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">'}\n'</span><span class="token punctuation">;</span>

    <span class="token comment">// 增加 print 功能</span>
    <span class="token comment">// __p 为返回的字符串</span>
    source <span class="token operator">=</span>
      <span class="token string">&quot;var __t,__p='',__j=Array.prototype.join,&quot;</span> <span class="token operator">+</span>
      <span class="token string">&quot;print=function(){__p+=__j.call(arguments,'');};\n&quot;</span> <span class="token operator">+</span>
      source <span class="token operator">+</span>
      <span class="token string">'return __p;\n'</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// render 方法，前两个参数为 render 方法的参数</span>
      <span class="token comment">// obj 为传入的 JSON 对象，传入 _ 参数使得函数内部能用 Underscore 的函数</span>
      <span class="token keyword">var</span> render <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span>variable <span class="token operator">||</span> <span class="token string">'obj'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">,</span> source<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 抛出错误</span>
      e<span class="token punctuation">.</span>source <span class="token operator">=</span> source<span class="token punctuation">;</span>
      <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 返回的函数</span>
    <span class="token comment">// data 一般是 JSON 数据，用来渲染模板</span>
    <span class="token keyword">var</span> <span class="token function-variable function">template</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// render 为模板渲染函数</span>
      <span class="token comment">// 传入参数 _ ，使得模板里 &lt;%  %&gt; 里的代码能用 underscore 的方法</span>
      <span class="token comment">//（&lt;%  %&gt; - to execute some code）</span>
      <span class="token keyword">return</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// Provide the compiled source as a convenience for precompilation.</span>
    <span class="token comment">// template.source for debug?</span>
    <span class="token comment">// obj 与 with(obj||{}) 中的 obj 对应</span>
    <span class="token keyword">var</span> argument <span class="token operator">=</span> settings<span class="token punctuation">.</span>variable <span class="token operator">||</span> <span class="token string">'obj'</span><span class="token punctuation">;</span>

    <span class="token comment">// 可通过 _.template(tpl).source 获取</span>
    <span class="token comment">// 可以用来预编译，在服务端预编译好，直接在客户端生成代码，客户端直接调用方法</span>
    <span class="token comment">// 这样如果出错就能打印出错行</span>
    <span class="token comment">// Precompiling your templates can be a big help when debugging errors you can't reproduce.</span>
    <span class="token comment">// This is because precompiled templates can provide line numbers and a stack trace,</span>
    <span class="token comment">// something that is not possible when compiling templates on the client.</span>
    <span class="token comment">// The source property is available on the compiled template function for easy precompilation.</span>
    <span class="token comment">// see @http://stackoverflow.com/questions/18755292/underscore-js-precompiled-templates-using</span>
    <span class="token comment">// see @http://stackoverflow.com/questions/13536262/what-is-javascript-template-precompiling</span>
    <span class="token comment">// see @http://stackoverflow.com/questions/40126223/can-anyone-explain-underscores-precompilation-in-template</span>
    <span class="token comment">// JST is a server-side thing, not client-side.</span>
    <span class="token comment">// This mean that you compile Unserscore template on server side by some server-side script and save the result in a file.</span>
    <span class="token comment">// Then use this file as compiled Unserscore template.</span>
    template<span class="token punctuation">.</span>source <span class="token operator">=</span> <span class="token string">'function('</span> <span class="token operator">+</span> argument <span class="token operator">+</span> <span class="token string">'){\n'</span> <span class="token operator">+</span> source <span class="token operator">+</span> <span class="token string">'}'</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> template<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Add a &quot;chain&quot; function. Start chaining a wrapped Underscore object.</span>
  <span class="token comment">// 使支持链式调用</span>
  <span class="token comment">/**
  // 非 OOP 调用 chain
  _.chain([1, 2, 3])
    .map(function(a) { return a * 2; })
    .reverse().value(); // [6, 4, 2]
  // OOP 调用 chain
  _([1, 2, 3])
    .chain()
    .map(function(a){ return a * 2; })
    .first()
    .value(); // 2
  **/</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">chain</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 无论是否 OOP 调用，都会转为 OOP 形式</span>
    <span class="token comment">// 并且给新的构造对象添加了一个 _chain 属性</span>
    <span class="token keyword">var</span> instance <span class="token operator">=</span> <span class="token function">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 标记是否使用链式操作</span>
    instance<span class="token punctuation">.</span>_chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token comment">// 返回 OOP 对象</span>
    <span class="token comment">// 可以看到该 instance 对象除了多了个 _chain 属性</span>
    <span class="token comment">// 其他的和直接 _(obj) 的结果一样</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// OOP</span>
  <span class="token comment">// ---------------</span>
  <span class="token comment">// If Underscore is called as a function, it returns a wrapped object that</span>
  <span class="token comment">// can be used OO-style. This wrapper holds altered versions of all the</span>
  <span class="token comment">// underscore functions. Wrapped objects may be chained.</span>

  <span class="token comment">// OOP</span>
  <span class="token comment">// 如果 `_` 被当做方法（构造函数）调用, 则返回一个被包装过的对象</span>
  <span class="token comment">// 该对象能使用 underscore 的所有方法</span>
  <span class="token comment">// 并且支持链式调用</span>

  <span class="token comment">// Helper function to continue chaining intermediate results.</span>
  <span class="token comment">// 一个帮助方法（Helper function）</span>
  <span class="token keyword">var</span> <span class="token function-variable function">result</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">instance<span class="token punctuation">,</span> obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果需要链式操作，则对 obj 运行 _.chain 方法，使得可以继续后续的链式操作</span>
    <span class="token comment">// 如果不需要，直接返回 obj</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">.</span>_chain <span class="token operator">?</span> <span class="token function">_</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Add your own custom functions to the Underscore object.</span>
  <span class="token comment">// 可向 underscore 函数库扩展自己的方法</span>
  <span class="token comment">// obj 参数必须是一个对象（JavaScript 中一切皆对象）</span>
  <span class="token comment">// 且自己的方法定义在 obj 的属性上</span>
  <span class="token comment">// 如 obj.myFunc = function() {...}</span>
  <span class="token comment">// 形如 {myFunc: function(){}}</span>
  <span class="token comment">// 之后便可使用如下: _.myFunc(..) 或者 OOP _(..).myFunc(..)</span>
  _<span class="token punctuation">.</span><span class="token function-variable function">mixin</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 遍历 obj 的 key，将方法挂载到 Underscore 上</span>
    <span class="token comment">// 其实是将方法浅拷贝到 _.prototype 上</span>
    _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>_<span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 直接把方法挂载到 _[name] 上</span>
      <span class="token comment">// 调用类似 _.myFunc([1, 2, 3], ..)</span>
      <span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token punctuation">(</span>_<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> obj<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 浅拷贝</span>
      <span class="token comment">// 将 name 方法挂载到 _ 对象的原型链上，使之能 OOP 调用</span>
      <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 第一个参数</span>
        <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// arguments 为 name 方法需要的其他参数</span>
        <span class="token function">push</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行 func 方法</span>
        <span class="token comment">// 支持链式操作</span>
        <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">func</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Add all of the Underscore functions to the wrapper object.</span>
  <span class="token comment">// 将前面定义的 underscore 方法添加给包装过的对象</span>
  <span class="token comment">// 即添加到 _.prototype 中</span>
  <span class="token comment">// 使 underscore 支持面向对象形式的调用</span>
  _<span class="token punctuation">.</span><span class="token function">mixin</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Add all mutator Array functions to the wrapper.</span>
  <span class="token comment">// 将 Array 原型链上有的方法都添加到 underscore 中</span>
  _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span><span class="token string">'pop'</span><span class="token punctuation">,</span> <span class="token string">'push'</span><span class="token punctuation">,</span> <span class="token string">'reverse'</span><span class="token punctuation">,</span> <span class="token string">'shift'</span><span class="token punctuation">,</span> <span class="token string">'sort'</span><span class="token punctuation">,</span> <span class="token string">'splice'</span><span class="token punctuation">,</span> <span class="token string">'unshift'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> method <span class="token operator">=</span> ArrayProto<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
        <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>name <span class="token operator">===</span> <span class="token string">'shift'</span> <span class="token operator">||</span> name <span class="token operator">===</span> <span class="token string">'splice'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span>
          <span class="token keyword">delete</span> obj<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token comment">// 支持链式操作</span>
        <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Add all accessor Array functions to the wrapper.</span>
  <span class="token comment">// 添加 concat、join、slice 等数组原生方法给 Underscore</span>
  _<span class="token punctuation">.</span><span class="token function">each</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'concat'</span><span class="token punctuation">,</span> <span class="token string">'join'</span><span class="token punctuation">,</span> <span class="token string">'slice'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> method <span class="token operator">=</span> ArrayProto<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">result</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">method</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Extracts the result from a wrapped and chained object.</span>
  <span class="token comment">// 一个包装过(OOP)并且链式调用的对象</span>
  <span class="token comment">// 用 value 方法获取结果</span>
  <span class="token comment">// _(obj).value === obj?</span>
  <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">value</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// Provide unwrapping proxy for some methods used in engine operations</span>
  <span class="token comment">// such as arithmetic and JSON stringification.</span>
  <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>valueOf <span class="token operator">=</span> <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toJSON <span class="token operator">=</span> <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

  <span class="token class-name">_</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">''</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_wrapped<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">// AMD registration happens at the end for compatibility with AMD loaders</span>
  <span class="token comment">// that may not enforce next-turn semantics on modules. Even though general</span>
  <span class="token comment">// practice for AMD registration is to be anonymous, underscore registers</span>
  <span class="token comment">// as a named module because, like jQuery, it is a base library that is</span>
  <span class="token comment">// popular enough to be bundled in a third party lib, but not be part of</span>
  <span class="token comment">// an AMD load request. Those cases could generate an error when an</span>
  <span class="token comment">// anonymous define() is called outside of a loader request.</span>
  <span class="token comment">// 兼容 AMD 规范</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">define</span><span class="token punctuation">(</span><span class="token string">'underscore'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> _<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div><div class="page-edit"><div class="edit-link"><a href="https://github.com/liweirose/knowledge/edit/master/docs/app/Underscore/Underscore-index.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div><div class="last-updated"><span class="prefix">上次更新: </span><span class="time">5/15/2019, 3:56:57 PM</span></div></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/knowledge/app/Engineering-Practice/Engineering-Practice-micro-service.html" class="prev">
          前端微服务实现方案
        </a></span><span class="next"><a href="/knowledge/app/Lodash/Lodash-isArray.html">
          isArray
        </a> →
      </span></p></div></div></div></div>
    <script src="/knowledge/assets/js/app.e7eda342.js" defer></script><script src="/knowledge/assets/js/79.e238b410.js" defer></script>
  </body>
</html>
